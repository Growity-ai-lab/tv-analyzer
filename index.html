<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Analyzer by Time</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.0.0"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent-blue: #00d4ff;
            --accent-purple: #7c3aed;
            --accent-orange: #ff6b35;
            --accent-green: #10b981;
            --accent-yellow: #f59e0b;
            --accent-pink: #ec4899;
            --text-primary: #f0f0f5;
            --text-secondary: #8888a0;
            --border-color: #2a2a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sora', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 40px 24px;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 48px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 52px;
            height: 52px;
            position: relative;
        }

        .logo-rings {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .logo-ring {
            position: absolute;
            border-radius: 50%;
            border: 6px solid;
        }

        .logo-ring.pink {
            width: 36px;
            height: 36px;
            border-color: #E91E8C;
            left: 0;
            top: 8px;
        }

        .logo-ring.purple {
            width: 36px;
            height: 36px;
            border-color: #7B2D8E;
            right: 0;
            top: 8px;
        }

        /* Interlocking effect - purple ring goes behind pink on left, in front on right */
        .logo-ring.purple::before {
            content: '';
            position: absolute;
            width: 12px;
            height: 20px;
            background: var(--bg-primary);
            left: -8px;
            top: 4px;
            border-radius: 0 10px 10px 0;
        }

        .logo-text h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(90deg, #E91E8C, #7B2D8E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text span {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
            text-transform: none;
            letter-spacing: 1px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .badge {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: var(--accent-blue);
            font-family: 'Space Mono', monospace;
        }

        .main-layout {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Controls Row 1 - GRP + Scenarios + Run */
        .controls-row-1 {
            display: flex;
            gap: 16px;
            align-items: stretch;
        }

        .grp-card {
            flex: 1;
        }

        .grp-card .control-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 0;
            border-bottom: none;
        }

        .cpp-inline {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .cpp-inline input {
            width: 80px;
            padding: 4px 8px;
            font-size: 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
        }

        .grp-inputs-row {
            display: flex;
            gap: 12px;
        }

        .grp-alt-input {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px;
        }

        .grp-alt-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .alt-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .alt-dot.alt1 { background: #00d4ff; }
        .alt-dot.alt2 { background: #ff6b35; }
        .alt-dot.alt3 { background: #10b981; }

        .alt-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grp-alt-header .alt-total {
            margin-left: auto;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .grp-alt-input textarea {
            width: 100%;
            height: 36px;
            font-size: 11px;
            padding: 8px;
            resize: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
        }

        .scenarios-card {
            width: 140px;
            flex-shrink: 0;
        }

        .scenarios-card .control-card-header {
            padding-bottom: 0;
            border-bottom: none;
            margin-bottom: 10px;
        }

        .scenario-buttons-vertical {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .scenario-btn-v {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-btn-v:hover {
            border-color: var(--accent-pink);
        }

        .scenario-btn-v.active {
            background: rgba(236, 72, 153, 0.15);
            border-color: var(--accent-pink);
        }

        .scenario-icon {
            font-size: 14px;
        }

        .scenario-name {
            font-size: 11px;
            color: var(--text-primary);
        }

        .run-analysis-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .run-analysis-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .run-icon {
            font-size: 24px;
            color: white;
        }

        .run-text {
            font-size: 12px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
        }

        /* Controls Row 2 - Parameters */
        .controls-row-2 {
            display: flex;
            align-items: center;
            gap: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px 20px;
        }

        .param-group {
            display: flex;
            gap: 24px;
        }

        .param-item {
            min-width: 140px;
        }

        .param-item label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .param-item label span {
            color: var(--accent-blue);
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .param-item input[type="range"] {
            width: 100%;
            height: 4px;
        }

        .param-scale {
            display: flex;
            justify-content: space-between;
            font-size: 8px;
            color: var(--text-secondary);
            margin-top: 2px;
            opacity: 0.6;
        }

        .param-divider {
            width: 1px;
            height: 50px;
            background: var(--border-color);
        }

        .sales-params {
            display: flex;
            gap: 16px;
        }

        .param-item-inline {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .param-item-inline label {
            font-size: 10px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .param-item-inline input {
            width: 90px;
            padding: 6px 10px;
            font-size: 11px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
        }

        .param-unit {
            font-size: 10px;
            color: var(--text-secondary);
        }

        /* Key Metrics - Simplified */
        .key-metrics {
            display: flex;
            align-items: stretch;
            gap: 16px;
        }

        .key-metric {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 20px;
            min-width: 180px;
        }

        .key-metric.highlight-metric {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 107, 53, 0.05));
            border-color: rgba(255, 215, 0, 0.3);
            flex: 1;
        }

        .key-metric-icon {
            font-size: 24px;
        }

        .key-metric-content {
            display: flex;
            flex-direction: column;
        }

        .key-metric-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .key-metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .metric-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-left: auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px 14px;
        }

        .metric-detail-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 12px;
            border-right: 1px solid var(--border-color);
        }

        .metric-detail-item:last-child {
            border-right: none;
        }

        .detail-label {
            font-size: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            white-space: nowrap;
        }

        .detail-value {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Control Card base */
        .control-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
        }

        .control-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-card-icon {
            font-size: 14px;
        }

        .control-card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Charts Section */
        .charts-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 32px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: rgba(0, 212, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.05);
        }

        .card.collapsed .card-body {
            display: none;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .card-header-content {
            flex: 1;
        }

        .card-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .card.collapsed .card-toggle {
            transform: rotate(-90deg);
        }

        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .card-icon.blue { background: rgba(0, 212, 255, 0.15); }
        .card-icon.purple { background: rgba(124, 58, 237, 0.15); }
        .card-icon.orange { background: rgba(255, 107, 53, 0.15); }
        .card-icon.green { background: rgba(16, 185, 129, 0.15); }
        .card-icon.yellow { background: rgba(245, 158, 11, 0.15); }
        .card-icon.pink { background: rgba(236, 72, 153, 0.15); }

        .card h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card p {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .card-body {
            margin-top: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-family: 'Space Mono', monospace;
        }

        .form-group label span {
            color: var(--accent-blue);
            font-weight: 700;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-secondary);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type="number"], input[type="text"] {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus, input[type="text"]:focus {
            border-color: var(--accent-blue);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .input-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .data-input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            resize: vertical;
            min-height: 80px;
            outline: none;
        }

        .data-input:focus {
            border-color: var(--accent-blue);
        }

        /* Effective Level Styles */
        .effective-level-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 12px;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px dashed var(--border-color);
        }

        .effective-level-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .effective-level-item label {
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .effective-level-item input {
            width: 65px;
            padding: 5px 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            text-align: center;
        }

        .effective-level-item input:focus {
            border-color: var(--accent-blue);
            outline: none;
        }

        .level-unit {
            font-size: 10px;
            color: var(--text-muted);
        }

        .effective-level-hint {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 212, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
            color: var(--accent-blue);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 11px;
        }

        .content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 14px;
        }

        .metric-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-blue);
        }

        .metric-value {
            font-family: 'Space Mono', monospace;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .metric-value.blue { color: var(--accent-blue); }
        .metric-value.purple { color: var(--accent-purple); }
        .metric-value.orange { color: var(--accent-orange); }
        .metric-value.green { color: var(--accent-green); }
        .metric-value.yellow { color: var(--accent-yellow); }
        .metric-value.pink { color: var(--accent-pink); }

        .metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tabs {
            display: flex;
            gap: 6px;
            background: var(--bg-card);
            padding: 5px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-family: 'Sora', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--accent-blue);
        }

        .tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .chart-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            height: 380px;
            position: relative;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: '';
            width: 4px;
            height: 18px;
            background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple));
            border-radius: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'Space Mono', monospace;
            font-size: 11px;
        }

        .data-table tr:hover td {
            background: rgba(0, 212, 255, 0.02);
        }

        .info-box {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .info-box-icon {
            font-size: 16px;
            color: var(--accent-blue);
        }

        .info-box-content h4 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .info-box-content p {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .formula {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px 14px;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            color: var(--accent-blue);
            margin-top: 10px;
        }

        .param-guide {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border-left: 3px solid var(--accent-purple);
        }

        .guide-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .guide-icon {
            font-size: 14px;
        }

        .guide-description {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.5;
        }

        .guide-scale {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
        }

        .scale-item {
            flex: 1;
            text-align: center;
            padding: 6px 4px;
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
        }

        .scale-item.low { border-bottom: 2px solid #f59e0b; }
        .scale-item.mid { border-bottom: 2px solid var(--accent-blue); }
        .scale-item.high { border-bottom: 2px solid var(--accent-green); }

        .scale-value {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .scale-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .guide-examples {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .example-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .example-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-top: 4px;
            flex-shrink: 0;
        }

        .example-dot.low { background: #f59e0b; }
        .example-dot.mid { background: var(--accent-blue); }
        .example-dot.high { background: var(--accent-green); }

        .guide-effect {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            font-size: 10px;
            color: var(--accent-orange);
            line-height: 1.5;
        }

        .effect-icon {
            font-size: 12px;
            flex-shrink: 0;
        }

        /* Optimal Point Indicator */
        .optimal-indicator {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(0, 212, 255, 0.1));
            border: 1px solid var(--accent-green);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
        }

        .optimal-indicator h4 {
            font-size: 12px;
            color: var(--accent-green);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .optimal-indicator .optimal-value {
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .optimal-indicator .optimal-desc {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Scenario Comparison */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .scenario-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .scenario-card:hover, .scenario-card.active {
            border-color: var(--accent-blue);
        }

        .scenario-card.active {
            background: rgba(0, 212, 255, 0.05);
        }

        .scenario-card h5 {
            font-size: 11px;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .scenario-card .scenario-params {
            font-size: 9px;
            color: var(--text-secondary);
            font-family: 'Space Mono', monospace;
        }

        /* GRP Calculator */
        .grp-result {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .grp-item {
            text-align: center;
        }

        .grp-item .value {
            font-family: 'Space Mono', monospace;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .grp-item .label {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* Mode Selector */
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .mode-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 10px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:hover {
            border-color: var(--accent-blue);
        }

        .mode-btn.active {
            border-color: var(--accent-blue);
            background: rgba(0, 212, 255, 0.1);
        }

        .mode-icon {
            font-size: 20px;
        }

        .mode-text {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mode-btn.active .mode-text {
            color: var(--accent-blue);
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        /* Input Summary */
        .input-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .summary-item {
            text-align: center;
            padding: 10px 6px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .summary-value {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .summary-label {
            font-size: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .toggle-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--bg-secondary);
            border-radius: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--accent-blue);
        }

        .toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(18px);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .scenario-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 500px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ROI Highlight */
        .roi-highlight {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(236, 72, 153, 0.1));
            border: 1px solid var(--accent-purple);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .roi-highlight .roi-value {
            font-family: 'Space Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .roi-highlight .roi-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 4px;
        }

        /* GRP & Reach Styles */
        .chart-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .reach-filters, .adstock-filters {
            display: flex;
            gap: 6px;
        }

        .saturation-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-secondary);
            padding: 3px;
            border-radius: 6px;
        }

        .sat-toggle-btn {
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: 'Sora', sans-serif;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sat-toggle-btn:hover {
            color: var(--text-primary);
        }

        .sat-toggle-btn.active {
            background: var(--accent-blue);
            color: white;
        }

        .reach-btn, .adstock-btn {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: 'Sora', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reach-btn:hover, .adstock-btn:hover {
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .reach-btn.active, .adstock-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .reach-summary {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .reach-stat {
            text-align: center;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            min-width: 100px;
        }

        .reach-stat-value {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .reach-stat-label {
            display: block;
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Reach Stats Row - grafikten ayrÄ± */
        .reach-stats-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 24px 0 16px 0;
        }

        .reach-stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 24px;
            text-align: center;
            min-width: 120px;
        }

        .reach-stat-card .reach-stat-value {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-yellow);
        }

        .reach-stat-card .reach-stat-label {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Tab Rationale (All tabs) */
        .tab-rationale {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }

        .rationale-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .rationale-icon {
            font-size: 18px;
        }

        .rationale-content {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .rationale-content p {
            margin-bottom: 12px;
        }

        .rationale-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .rationale-content li {
            margin-bottom: 6px;
        }

        .rationale-content strong {
            color: var(--text-primary);
        }

        .rationale-content .highlight {
            color: #ef4444;
            font-weight: 600;
        }

        .rationale-content .highlight-green {
            color: #10b981;
            font-weight: 600;
        }

        .rationale-content .highlight-blue {
            color: #00d4ff;
            font-weight: 600;
        }

        .rationale-content .highlight-purple {
            color: #7c3aed;
            font-weight: 600;
        }

        .rationale-recommendation {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(0, 212, 255, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .rationale-recommendation strong {
            color: #10b981;
            display: block;
            margin-bottom: 6px;
        }

        .rationale-recommendation p {
            margin: 6px 0;
        }

        .rationale-tip {
            background: rgba(124, 58, 237, 0.1);
            border-left: 3px solid #7c3aed;
            padding: 10px 12px;
            margin: 12px 0;
            border-radius: 0 8px 8px 0;
        }

        .rationale-tip strong {
            color: #7c3aed;
        }

        .rationale-data-section {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .rationale-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 11px;
        }

        .rationale-table th,
        .rationale-table td {
            padding: 6px 8px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .rationale-table th {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
        }

        .rationale-table td:first-child {
            text-align: left;
        }

        .status-good { color: #10b981; font-weight: 600; }
        .status-warning { color: #f59e0b; font-weight: 600; }
        .status-info { color: #00d4ff; font-weight: 600; }

        .rationale-recommendation.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.1));
            border-color: rgba(245, 158, 11, 0.4);
        }

        .rationale-recommendation.warning strong {
            color: #f59e0b;
        }

        .rationale-recommendation.info {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.05));
            border-color: rgba(0, 212, 255, 0.3);
        }

        .rationale-recommendation.info strong {
            color: #00d4ff;
        }

        .rationale-recommendation ul {
            margin: 8px 0;
            padding-left: 18px;
        }

        .rationale-recommendation li {
            margin-bottom: 4px;
        }

        .rationale-scenario {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            border-left: 3px solid var(--accent-pink);
        }

        .rationale-scenario-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-pink);
            margin-bottom: 8px;
        }

        /* Alternative Input Styles */
        .alt-input-group {
            margin-bottom: 12px;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--border-color);
        }

        .alt-input-group:nth-child(2) { border-left-color: #00d4ff; }
        .alt-input-group:nth-child(3) { border-left-color: #ff6b35; }
        .alt-input-group:nth-child(4) { border-left-color: #10b981; }

        .alt-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .alt-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .alt-badge.alt1 { background: #00d4ff; color: #0a0a0f; }
        .alt-badge.alt2 { background: #ff6b35; color: white; }
        .alt-badge.alt3 { background: #10b981; color: white; }

        .alt-name {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .alt-input-group .data-input {
            height: 50px;
            font-size: 11px;
        }

        .alt-summary {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .alt-summary-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: 6px;
        }

        .alt-summary-value {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .param-hint {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }

        /* Chart Legend for Alternatives */
        .alt-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 12px;
        }

        .alt-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .alt-legend-color {
            width: 12px;
            height: 3px;
            border-radius: 2px;
        }

        .alt-legend-color.alt1 { background: #00d4ff; }
        .alt-legend-color.alt2 { background: #ff6b35; }
        .alt-legend-color.alt3 { background: #10b981; }

        /* Compact Alternative Input */
        .alt-input-compact {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .alt-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .alt-row .alt-badge {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            flex-shrink: 0;
        }

        .alt-row textarea {
            flex: 1;
            height: 28px;
            font-size: 10px;
            padding: 4px 6px;
            resize: none;
        }

        .alt-total {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            min-width: 35px;
            text-align: right;
        }

        /* Metrics Row */
        .metrics-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .metric-mini {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
            flex: 1;
        }

        .metric-mini.highlight {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .metric-mini-value {
            font-family: 'Space Mono', monospace;
            font-size: 14px;
            font-weight: 700;
        }

        .metric-mini-value.blue { color: #00d4ff; }
        .metric-mini-value.purple { color: #7c3aed; }
        .metric-mini-value.orange { color: #ff6b35; }
        .metric-mini-value.green { color: #10b981; }
        .metric-mini-value.pink { color: #ec4899; }
        .metric-mini-value.yellow { color: #ffd700; }
        .metric-mini-value.cyan { color: #00d4ff; }

        .metric-mini-label {
            font-size: 9px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 2px;
        }

        /* Scenario Buttons */
        .scenario-buttons {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .scenario-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .scenario-btn:hover {
            border-color: var(--accent-pink);
            color: var(--text-primary);
        }

        .scenario-btn.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: var(--accent-pink);
            color: var(--accent-pink);
        }

        .scenario-info {
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 2px solid var(--accent-pink);
        }

        .scenario-params-mini {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--accent-pink);
        }

        .scenario-desc {
            display: block;
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        /* Compact Button */
        .btn-compact {
            width: 100%;
            padding: 8px;
            font-size: 11px;
            margin-top: 8px;
        }

        /* Scenario Explanation */
        .scenario-explanation {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 14px;
            margin-top: 16px;
            border-left: 3px solid var(--accent-pink);
        }

        .explanation-header {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .explanation-content {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .explanation-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-pink);
            margin-bottom: 8px;
        }

        .explanation-content ul {
            margin: 8px 0;
            padding-left: 16px;
        }

        .explanation-content li {
            margin-bottom: 4px;
        }

        .explanation-content strong {
            color: var(--text-primary);
        }

        .explanation-usage {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
            font-style: italic;
        }

        /* Model Fit Card */
        .model-fit-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .model-fit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--accent-purple), #9333ea);
            border: none;
            border-radius: 8px;
            color: white;
            font-family: 'Sora', sans-serif;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .model-fit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
        }

        .model-fit-status {
            text-align: center;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .model-fit-status.success {
            color: var(--accent-green);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .fit-instructions {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .fit-instructions p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .fit-instructions p:last-child {
            margin-bottom: 0;
        }

        .fit-instructions strong {
            color: var(--accent-purple);
        }

        .fit-data-inputs {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 16px;
        }

        .fit-input-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .fit-input-group textarea {
            width: 100%;
            height: 60px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            resize: vertical;
        }

        .fit-input-group textarea:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        .fit-options {
            margin-bottom: 20px;
        }

        .fit-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .fit-checkbox input {
            accent-color: var(--accent-purple);
        }

        .fit-progress {
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-blue));
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: center;
            margin-top: 8px;
        }

        .fit-results {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .fit-results h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 12px;
        }

        .fit-param .param-quality {
            display: block;
            font-size: 9px;
            margin-top: 2px;
            font-weight: 500;
        }

        .fit-param .param-quality.excellent { color: var(--accent-green); }
        .fit-param .param-quality.good { color: var(--accent-blue); }
        .fit-param .param-quality.acceptable { color: var(--accent-yellow); }
        .fit-param .param-quality.poor { color: var(--accent-orange); }

        .fit-rationale {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .fit-rationale h5 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .fit-rationale p {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 8px;
        }

        .fit-rationale .r2-scale {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 12px 0;
            font-size: 10px;
        }

        .fit-rationale .r2-bar {
            flex: 1;
            height: 8px;
            background: linear-gradient(90deg, 
                var(--accent-orange) 0%, 
                var(--accent-yellow) 50%, 
                var(--accent-blue) 75%, 
                var(--accent-green) 100%);
            border-radius: 4px;
            position: relative;
        }

        .fit-rationale .r2-marker {
            position: absolute;
            top: -4px;
            width: 2px;
            height: 16px;
            background: white;
            border-radius: 1px;
            box-shadow: 0 0 4px rgba(0,0,0,0.5);
        }

        .fit-rationale .r2-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .fit-interpretation {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }

        .fit-interpretation .interp-title {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .fit-interpretation .interp-title.excellent { color: var(--accent-green); }
        .fit-interpretation .interp-title.good { color: var(--accent-blue); }
        .fit-interpretation .interp-title.acceptable { color: var(--accent-yellow); }
        .fit-interpretation .interp-title.poor { color: var(--accent-orange); }

        .fit-interpretation ul {
            margin: 0;
            padding-left: 16px;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .fit-interpretation li {
            margin-bottom: 4px;
        }

        /* GRP Distribution Analysis Styles */
        .distribution-analysis {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .dist-alt {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
        }

        .dist-alt:last-child {
            border-bottom: none;
        }

        .dist-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .dist-detail {
            margin-left: auto;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .dist-strategy {
            margin-top: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--accent-purple);
        }

        .dist-strategy p {
            margin-bottom: 8px !important;
        }

        .dist-strategy ul {
            margin: 0;
            padding-left: 16px;
        }

        .dist-strategy li {
            margin-bottom: 4px;
            font-size: 11px;
        }

        .dist-recommendation {
            margin-top: 12px;
            padding: 10px 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(0, 212, 255, 0.1));
            border-radius: 8px;
            font-size: 11px;
        }

        /* Week-by-week Analysis Styles */
        .week-analysis {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .week-breakdown {
            margin-top: 8px;
        }

        .week-item {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
        }

        .week-item:last-child {
            border-bottom: none;
        }

        .week-item.more {
            color: var(--text-secondary);
            font-style: italic;
        }

        .week-label {
            font-weight: 600;
            color: var(--accent-blue);
            min-width: 30px;
        }

        .week-detail {
            color: var(--text-primary);
        }

        .week-carryover {
            color: var(--accent-purple);
            font-size: 10px;
            margin-left: auto;
        }

        .adstock-summary {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
        }

        .adstock-summary ul {
            margin: 8px 0 0 0;
            padding-left: 16px;
        }

        .adstock-summary li {
            margin-bottom: 4px;
            font-size: 11px;
        }

        .decay-explanation {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(0, 212, 255, 0.05));
            border-left: 3px solid var(--accent-purple);
            border-radius: 0 8px 8px 0;
            padding: 12px;
            margin: 12px 0;
        }

        .decay-explanation p {
            margin-bottom: 8px;
        }

        .decay-explanation ul {
            margin: 0;
            padding-left: 16px;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .decay-visual {
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            color: var(--accent-purple);
            margin: 8px 0;
            flex-wrap: wrap;
        }

        .decay-visual span {
            background: var(--bg-card);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .decay-note {
            font-size: 11px;
            color: var(--accent-green);
            font-weight: 500;
            margin-top: 8px !important;
        }

        .week-item.tail-week {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 4px;
            padding: 6px 8px;
            margin: 2px 0;
        }

        .week-item .tail-text {
            color: var(--accent-green);
        }

        .week-badge {
            font-size: 9px;
            background: var(--accent-green);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
        }

        .fit-params-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .fit-param {
            background: var(--bg-card);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
        }

        .fit-param .param-name {
            display: block;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .fit-param .param-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-purple);
            font-family: 'Space Mono', monospace;
        }

        .fit-actions {
            display: flex;
            gap: 12px;
        }

        .fit-run-btn, .fit-apply-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Sora', sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .fit-run-btn {
            background: linear-gradient(135deg, var(--accent-purple), #9333ea);
            color: white;
        }

        .fit-run-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
        }

        .fit-run-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .fit-apply-btn {
            background: linear-gradient(135deg, var(--accent-green), #059669);
            color: white;
        }

        .fit-apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <svg width="52" height="44" viewBox="0 0 52 44" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <!-- Pink ring (left) - back part behind purple -->
                        <circle cx="17" cy="22" r="13" stroke="#E91E8C" stroke-width="5" fill="none" stroke-linecap="round"/>
                        <!-- Purple ring (right) - full circle -->
                        <circle cx="35" cy="22" r="13" stroke="#7B2D8E" stroke-width="5" fill="none" stroke-linecap="round"/>
                        <!-- Pink ring front overlap - covers the intersection area -->
                        <path d="M 17 9 A 13 13 0 0 0 17 35" stroke="#E91E8C" stroke-width="5" fill="none" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <h1>TV Analyzer</h1>
                    <span>by Growity AI Studio</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
                    ð¥ CSV Export
                </button>
                <div class="badge">v2.1</div>
            </div>
        </header>

        <div class="main-layout">
            <!-- Top Controls - Row 1: GRP + Scenarios + Run Button -->
            <div class="controls-row-1">
                <!-- GRP Alternatives - Wider -->
                <div class="control-card grp-card">
                    <div class="control-card-header">
                        <span class="control-card-icon">ð</span>
                        <span class="control-card-title">GRP Alternatifleri</span>
                        <div class="cpp-inline">
                            <span>CPP:</span>
                            <input type="number" id="cppValue" value="25000" step="1000">
                            <span>TL</span>
                        </div>
                    </div>
                    <div class="grp-inputs-row">
                        <div class="grp-alt-input">
                            <div class="grp-alt-header">
                                <span class="alt-dot alt1"></span>
                                <span class="alt-label">Alt-1</span>
                                <span class="alt-total" id="summaryAlt1">1700 GRP</span>
                            </div>
                            <textarea class="data-input" id="grpAlt1" placeholder="Hafta 1, Hafta 2, ...">300, 300, 200, 200, 200, 100, 200, 200</textarea>
                        </div>
                        <div class="grp-alt-input">
                            <div class="grp-alt-header">
                                <span class="alt-dot alt2"></span>
                                <span class="alt-label">Alt-2</span>
                                <span class="alt-total" id="summaryAlt2">1700 GRP</span>
                            </div>
                            <textarea class="data-input" id="grpAlt2" placeholder="Hafta 1, Hafta 2, ..."></textarea>
                        </div>
                        <div class="grp-alt-input">
                            <div class="grp-alt-header">
                                <span class="alt-dot alt3"></span>
                                <span class="alt-label">Alt-3</span>
                                <span class="alt-total" id="summaryAlt3">1700 GRP</span>
                            </div>
                            <textarea class="data-input" id="grpAlt3" placeholder="Hafta 1, Hafta 2, ..."></textarea>
                        </div>
                    </div>
                    <!-- Effective Level Settings -->
                    <div class="effective-level-row">
                        <div class="effective-level-item">
                            <label>ð Etkin Seviye (Alt)</label>
                            <input type="number" id="effectiveLow" value="195" min="0" step="5">
                            <span class="level-unit">GRP</span>
                        </div>
                        <div class="effective-level-item">
                            <label>ð Etkin Seviye (Ãst)</label>
                            <input type="number" id="effectiveHigh" value="300" min="0" step="5">
                            <span class="level-unit">GRP</span>
                        </div>
                        <div class="effective-level-hint">
                            <span>ð¡ Adstock grafiÄinde referans Ã§izgiler olarak gÃ¶sterilir</span>
                        </div>
                    </div>
                </div>

                <!-- Scenarios -->
                <div class="control-card scenarios-card">
                    <div class="control-card-header">
                        <span class="control-card-icon">ð¯</span>
                        <span class="control-card-title">Senaryo</span>
                    </div>
                    <div class="scenario-buttons-vertical">
                        <button class="scenario-btn-v" onclick="applyScenario('minimum')">
                            <span class="scenario-icon">ð</span>
                            <span class="scenario-name">Minimum</span>
                        </button>
                        <button class="scenario-btn-v active" onclick="applyScenario('optimum')">
                            <span class="scenario-icon">âï¸</span>
                            <span class="scenario-name">Optimum</span>
                        </button>
                        <button class="scenario-btn-v" onclick="applyScenario('maksimum')">
                            <span class="scenario-icon">ð</span>
                            <span class="scenario-name">Maksimum</span>
                        </button>
                    </div>
                </div>

                <!-- Model Fit Button -->
                <div class="control-card model-fit-card">
                    <div class="control-card-header">
                        <span class="control-card-icon">ð§ª</span>
                        <span class="control-card-title">Model Fit</span>
                    </div>
                    <button class="model-fit-btn" onclick="openModelFitModal()">
                        <span class="fit-icon">ð</span>
                        <span class="fit-text">Veriden Parametreleri ÃÄren</span>
                    </button>
                    <div class="model-fit-status" id="modelFitStatus">
                        <span class="status-text">HazÄ±r</span>
                    </div>
                </div>

                <!-- Run Button - Prominent -->
                <button class="run-analysis-btn" onclick="runAnalysis()">
                    <span class="run-icon">â¶</span>
                    <span class="run-text">Analizi ÃalÄ±ÅtÄ±r</span>
                </button>
            </div>

            <!-- Top Controls - Row 2: Parameters -->
            <div class="controls-row-2">
                <!-- Model Parameters -->
                <div class="param-group">
                    <div class="param-item">
                        <label>ð Etki SÃ¼resi <span id="decayValue">0.70</span></label>
                        <input type="range" id="decayRate" min="0" max="0.95" step="0.05" value="0.70">
                        <div class="param-scale">
                            <span>KÄ±sa</span>
                            <span>Uzun</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>ð Doygunluk <span id="alphaValue">1.50</span></label>
                        <input type="range" id="alphaParam" min="0.5" max="5" step="0.1" value="1.5">
                        <div class="param-scale">
                            <span>Erken</span>
                            <span>GeÃ§</span>
                        </div>
                    </div>
                    <div class="param-item">
                        <label>â¡ Etki HÄ±zÄ± <span id="gammaValue">0.80</span></label>
                        <input type="range" id="gammaParam" min="0.3" max="2" step="0.05" value="0.80">
                        <div class="param-scale">
                            <span>YavaÅ</span>
                            <span>HÄ±zlÄ±</span>
                        </div>
                    </div>
                </div>

                <div class="param-divider"></div>

                <!-- Sales Parameters -->
                <div class="param-group sales-params">
                    <div class="param-item-inline">
                        <label>ðª Baz SatÄ±Å</label>
                        <input type="number" id="baseline" value="5000000" step="100000">
                        <span class="param-unit">TL/hafta</span>
                    </div>
                    <div class="param-item-inline">
                        <label>ð Max TV Etkisi</label>
                        <input type="number" id="maxLift" value="30" step="1">
                        <span class="param-unit">%</span>
                    </div>
                </div>
            </div>

            <!-- Key Metrics - Simplified to 3 main + details -->
            <div class="key-metrics">
                <div class="key-metric">
                    <div class="key-metric-icon">ð°</div>
                    <div class="key-metric-content">
                        <span class="key-metric-value" id="totalSpend">-</span>
                        <span class="key-metric-label">Toplam Harcama</span>
                    </div>
                </div>
                <div class="key-metric highlight-metric">
                    <div class="key-metric-icon">ð</div>
                    <div class="key-metric-content">
                        <span class="key-metric-value" id="overallROI">-</span>
                        <span class="key-metric-label">TV KaynaklÄ± SatÄ±Å ArtÄ±ÅÄ±</span>
                    </div>
                </div>
                <div class="key-metric">
                    <div class="key-metric-icon">â¡</div>
                    <div class="key-metric-content">
                        <span class="key-metric-value" id="tvEfficiency">-</span>
                        <span class="key-metric-label">Verimlilik Index</span>
                    </div>
                </div>
                <div class="metric-details">
                    <div class="metric-detail-item">
                        <span class="detail-label">Ort. Adstock</span>
                        <span class="detail-value" id="avgAdstock">-</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="detail-label">Peak Saturation</span>
                        <span class="detail-value" id="peakEffect">-</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="detail-label">Optimal BÃ¼tÃ§e</span>
                        <span class="detail-value" id="optimalBudget">-</span>
                    </div>
                    <div class="metric-detail-item">
                        <span class="detail-label">Toplam SatÄ±Å</span>
                        <span class="detail-value" id="totalResponse">-</span>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('adstock')">Carryover & Adstock</button>
                    <button class="tab" onclick="switchTab('saturation')">Saturation</button>
                    <button class="tab" onclick="switchTab('reach')">GRP & Reach</button>
                </div>

                <!-- Chart Containers -->
                <div id="adstock-tab" class="tab-content active">
                    <div class="chart-container">
                        <div class="chart-title">Carryover & Adstock - Alternatif KarÅÄ±laÅtÄ±rmasÄ±</div>
                        <div style="height: 350px;">
                            <canvas id="adstockChart"></canvas>
                        </div>
                    </div>
                    <div class="tab-rationale">
                        <div class="rationale-header">
                            <span class="rationale-icon">ð</span>
                            <span>Grafik Rasyoneli</span>
                        </div>
                        <div class="rationale-content" id="adstockRationale">
                            <!-- Dinamik iÃ§erik buraya gelecek -->
                        </div>
                    </div>
                </div>

                <div id="saturation-tab" class="tab-content">
                    <div class="chart-container">
                        <div class="chart-header-row">
                            <div class="chart-title">Saturation Curve - Optimal Nokta Ä°Åaretli</div>
                            <div class="saturation-toggle">
                                <button class="sat-toggle-btn active" onclick="setSaturationXAxis('grp')" id="satToggleGRP">GRP</button>
                                <button class="sat-toggle-btn" onclick="setSaturationXAxis('spend')" id="satToggleSpend">Harcama (TL)</button>
                            </div>
                        </div>
                        <canvas id="saturationChart"></canvas>
                    </div>
                    <div class="tab-rationale">
                        <div class="rationale-header">
                            <span class="rationale-icon">ð</span>
                            <span>Grafik Rasyoneli</span>
                        </div>
                        <div class="rationale-content" id="saturationRationale">
                            <!-- Dinamik iÃ§erik buraya gelecek -->
                        </div>
                    </div>
                </div>

                <!-- GRP & Reach Tab -->
                <div id="reach-tab" class="tab-content">
                    <div class="chart-container">
                        <div class="chart-header-row">
                            <div class="chart-title">HaftalÄ±k GRP & EriÅim Seviyesi</div>
                            <div class="reach-filters">
                                <button class="reach-btn" onclick="setReachFrequency('all')">Hepsi</button>
                                <button class="reach-btn active" onclick="setReachFrequency(1)">1+ Reach</button>
                                <button class="reach-btn" onclick="setReachFrequency(2)">2+ Reach</button>
                                <button class="reach-btn" onclick="setReachFrequency(3)">3+ Reach</button>
                            </div>
                        </div>
                        <div style="height: 320px; padding-bottom: 10px;">
                            <canvas id="reachChart"></canvas>
                        </div>
                    </div>
                    <!-- Summary kutularÄ± grafikten AYRI -->
                    <div class="reach-stats-row">
                        <div class="reach-stat-card">
                            <span class="reach-stat-value" id="reachMaxGRP">-</span>
                            <span class="reach-stat-label">Toplam GRP</span>
                        </div>
                        <div class="reach-stat-card">
                            <span class="reach-stat-value" id="reachMaxPercent">-</span>
                            <span class="reach-stat-label" id="reachFreqLabel">1+ Reach</span>
                        </div>
                        <div class="reach-stat-card">
                            <span class="reach-stat-value" id="reachOptimalGRP">-</span>
                            <span class="reach-stat-label">Optimal GRP</span>
                        </div>
                    </div>
                    <div class="tab-rationale">
                        <div class="rationale-header">
                            <span class="rationale-icon">ð</span>
                            <span>Grafik Rasyoneli</span>
                        </div>
                        <div class="rationale-content" id="reachRationale">
                            <!-- Dinamik iÃ§erik buraya gelecek -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Fit Modal -->
    <div id="modelFitModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ð§ª Model Fit - Parametreleri Veriden ÃÄren</h3>
                <button class="modal-close" onclick="closeModelFitModal()">Ã</button>
            </div>
            <div class="modal-body">
                <div class="fit-instructions">
                    <p><strong>NasÄ±l ÃalÄ±ÅÄ±r?</strong></p>
                    <p>HaftalÄ±k satÄ±Å ve TV harcama/GRP verilerinizi girin. Python modeli tarayÄ±cÄ±nÄ±zda Ã§alÄ±Åarak en uygun Decay, Alpha ve Gamma parametrelerini bulacak.</p>
                </div>
                
                <div class="fit-data-inputs">
                    <div class="fit-input-group">
                        <label>ð HaftalÄ±k SatÄ±Å (TL)</label>
                        <textarea id="fitSalesData" placeholder="1200000, 1350000, 1500000, 1400000, 1300000, 1250000, 1400000, 1450000">1200000, 1350000, 1500000, 1400000, 1300000, 1250000, 1400000, 1450000</textarea>
                    </div>
                    <div class="fit-input-group">
                        <label>ðº HaftalÄ±k TV Harcama (TL) veya GRP</label>
                        <textarea id="fitTVData" placeholder="500000, 600000, 700000, 500000, 400000, 300000, 500000, 600000">500000, 600000, 700000, 500000, 400000, 300000, 500000, 600000</textarea>
                    </div>
                </div>

                <div class="fit-options">
                    <label class="fit-checkbox">
                        <input type="checkbox" id="fitAutoApply" checked>
                        <span>Bulunan parametreleri otomatik uygula</span>
                    </label>
                </div>

                <div class="fit-progress" id="fitProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Pyodide yÃ¼kleniyor...</div>
                </div>

                <div class="fit-results" id="fitResults" style="display: none;">
                    <h4>ð Bulunan Parametreler</h4>
                    <div class="fit-params-grid">
                        <div class="fit-param">
                            <span class="param-name">Decay (Î»)</span>
                            <span class="param-value" id="fitDecay">-</span>
                        </div>
                        <div class="fit-param">
                            <span class="param-name">Alpha (Î±)</span>
                            <span class="param-value" id="fitAlpha">-</span>
                        </div>
                        <div class="fit-param">
                            <span class="param-name">Gamma (Î³)</span>
                            <span class="param-value" id="fitGamma">-</span>
                        </div>
                        <div class="fit-param">
                            <span class="param-name">RÂ² Score</span>
                            <span class="param-value" id="fitR2">-</span>
                            <span class="param-quality" id="fitR2Quality">-</span>
                        </div>
                    </div>
                    
                    <div class="fit-rationale" id="fitRationale">
                        <!-- Dinamik rasyonel buraya gelecek -->
                    </div>
                </div>

                <div class="fit-actions">
                    <button class="fit-run-btn" onclick="runModelFit()">
                        <span>ð</span> Modeli ÃalÄ±ÅtÄ±r
                    </button>
                    <button class="fit-apply-btn" id="fitApplyBtn" onclick="applyFitParams()" style="display: none;">
                        <span>â</span> Parametreleri Uygula
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let adstockChart, saturationChart, reachChart;
        let analysisData = {};
        let inputMode = 'spend'; // 'spend' or 'grp'
        let currentReachFrequency = 1; // 1+, 2+, or 3+
        let currentAdstockAlt = 1; // 1, 2, or 3
        let currentCarryoverAlt = 1; // 1, 2, or 3
        let currentScenario = 'optimum'; // 'minimum', 'optimum', or 'maksimum'
        
        // Pyodide for Python model fitting
        let pyodide = null;
        let pyodideReady = false;
        let fittedParams = null;

        // Reach curve parameters for different frequencies
        // Reach Lookup Table - Coverguide verisi
        const reachLookup = {
            50: { r1: 30.3, r2: 10.2, r3: 3.3 },
            100: { r1: 44.6, r2: 23.2, r3: 11.7 },
            150: { r1: 52.8, r2: 33.0, r3: 20.4 },
            200: { r1: 58.2, r2: 40.2, r3: 27.7 },
            250: { r1: 61.9, r2: 45.6, r3: 33.7 },
            300: { r1: 64.7, r2: 49.7, r3: 38.5 },
            350: { r1: 66.9, r2: 53.1, r3: 42.5 },
            400: { r1: 68.7, r2: 55.8, r3: 45.8 },
            450: { r1: 70.1, r2: 58.1, r3: 48.6 },
            500: { r1: 71.4, r2: 60.0, r3: 51.0 },
            550: { r1: 72.4, r2: 61.6, r3: 53.1 },
            600: { r1: 73.3, r2: 63.1, r3: 54.9 },
            650: { r1: 74.1, r2: 64.4, r3: 56.5 },
            700: { r1: 74.8, r2: 65.5, r3: 58.0 },
            750: { r1: 75.4, r2: 66.5, r3: 59.3 },
            800: { r1: 76.0, r2: 67.4, r3: 60.4 },
            850: { r1: 76.5, r2: 68.2, r3: 61.5 },
            900: { r1: 77.0, r2: 69.0, r3: 62.5 },
            950: { r1: 77.4, r2: 69.7, r3: 63.3 },
            1000: { r1: 77.8, r2: 70.3, r3: 64.2 },
            1050: { r1: 78.1, r2: 70.9, r3: 64.9 },
            1100: { r1: 78.5, r2: 71.5, r3: 65.6 },
            1150: { r1: 78.8, r2: 72.0, r3: 66.3 },
            1200: { r1: 79.0, r2: 72.5, r3: 66.9 },
            1250: { r1: 79.3, r2: 72.9, r3: 67.5 },
            1300: { r1: 79.5, r2: 73.3, r3: 68.1 },
            1350: { r1: 79.8, r2: 73.7, r3: 68.6 },
            1400: { r1: 80.0, r2: 74.1, r3: 69.1 },
            1450: { r1: 80.2, r2: 74.4, r3: 69.5 },
            1500: { r1: 80.4, r2: 74.8, r3: 70.0 },
            1550: { r1: 80.6, r2: 75.1, r3: 70.4 },
            1600: { r1: 80.7, r2: 75.4, r3: 70.8 },
            1650: { r1: 80.9, r2: 75.6, r3: 71.1 },
            1700: { r1: 81.1, r2: 75.9, r3: 71.5 },
            1750: { r1: 81.2, r2: 76.2, r3: 71.8 },
            1800: { r1: 81.4, r2: 76.4, r3: 72.2 },
            1850: { r1: 81.5, r2: 76.6, r3: 72.5 },
            1900: { r1: 81.6, r2: 76.8, r3: 72.8 },
            1950: { r1: 81.7, r2: 77.0, r3: 73.0 },
            2000: { r1: 81.9, r2: 77.2, r3: 73.3 }
        };

        // Reach params for labels (still needed for UI)
        const reachParams = {
            1: { label: '1+ Reach' },
            2: { label: '2+ Reach' },
            3: { label: '3+ Reach' }
        };

        // Scenario-specific rationale content
        const scenarioRationales = {
            minimum: {
                name: 'Minimum',
                icon: 'ð',
                adstock: {
                    main: `<p><strong>ð Grafik Ne GÃ¶steriyor?</strong></p>
                    <ul>
                        <li><strong>Barlar:</strong> HaftalÄ±k Carryover (GRP eq.) - geÃ§miÅ haftalardan taÅÄ±nan etki</li>
                        <li><strong>Ãizgiler:</strong> Toplam Adstock - birikimli reklam etkisi</li>
                    </ul>
                    <p><strong>Minimum Senaryo (Î» = 0.45):</strong> DÃ¼ÅÃ¼k decay ile reklam etkisi <span class="highlight">1-2 hafta iÃ§inde %80+ kaybolur</span>.</p>`,
                    scenario: `<p><strong>ð Grafikte Ne GÃ¶rmelisiniz?</strong></p>
                    <ul>
                        <li>Carryover barlarÄ± Ã§ok kÄ±sa - geÃ§miÅten az etki taÅÄ±nÄ±yor</li>
                        <li>Adstock Ã§izgileri barlara yakÄ±n seyreder</li>
                        <li>GRP olmayan haftalarda adstock hÄ±zla dÃ¼Åer</li>
                    </ul>
                    <div class="rationale-recommendation warning">
                        <strong>â ï¸ Dikkat Edilmesi Gerekenler:</strong>
                        <p>Carryover barlarÄ± Ã§ok kÄ±saysa, her hafta yeniden "sÄ±fÄ±rdan" baÅlÄ±yorsunuz demektir. Bu durumda:</p>
                        <ul>
                            <li>SÃ¼rekli yayÄ±n yapmalÄ±sÄ±nÄ±z, 1 hafta bile boÅluk etkiyi sÄ±fÄ±rlar</li>
                            <li>Burst stratejisi bu senaryoda verimsizdir</li>
                        </ul>
                    </div>
                    <div class="rationale-recommendation">
                        <strong>ð¡ Aksiyon Ãnerileri:</strong>
                        <ul>
                            <li>HaftalÄ±k minimum 150-200 GRP ile sÃ¼rekli yayÄ±n planlayÄ±n</li>
                            <li>Promosyon dÃ¶nemlerinde yoÄunlaÅtÄ±rÄ±n ama hiÃ§ bÄ±rakmayÄ±n</li>
                            <li>Flight (ara verme) stratejisi kullanmayÄ±n</li>
                        </ul>
                    </div>
                    <div class="rationale-tip">
                        <strong>ð Benchmark:</strong> FMCG sektÃ¶rÃ¼nde tipik decay 0.4-0.5 arasÄ±ndadÄ±r.
                    </div>`
                },
                saturation: {
                    main: `<p><strong>Saturation GrafiÄi Ne GÃ¶steriyor?</strong> Harcama arttÄ±kÃ§a elde edilen etkinin nasÄ±l deÄiÅtiÄini gÃ¶sterir.</p>
                    <p><strong>Minimum Senaryo (Î± = 1.0, Î³ = 1.3):</strong> DÃ¼ÅÃ¼k alpha = <span class="highlight">erken doygunluk</span>. YÃ¼ksek gamma = keskin S-eÄrisi.</p>`,
                    scenario: `<p><strong>ð Minimum Saturation Ãzellikleri:</strong></p>
                    <ul>
                        <li>Belirli bir eÅiÄe kadar dÃ¼ÅÃ¼k etki</li>
                        <li>EÅik aÅÄ±ldÄ±ÄÄ±nda hÄ±zlÄ± verim artÄ±ÅÄ±</li>
                        <li>Optimal noktayÄ± aÅmak israftÄ±r</li>
                    </ul>`
                },
                reach: {
                    main: `<p><strong>GRP-Reach GrafiÄi Ne GÃ¶steriyor?</strong> KÃ¼mÃ¼latif GRP'nin ne kadar kitleye ulaÅtÄ±ÄÄ±nÄ± gÃ¶sterir.</p>`,
                    scenario: `<p><strong>ð Minimum Senaryo iÃ§in Reach Stratejisi:</strong></p>
                    <ul>
                        <li><strong>3+ Reach:</strong> â­ Ãnerilen - yÃ¼ksek frekans ile anlÄ±k etki</li>
                    </ul>
                    <div class="rationale-recommendation">
                        <strong>ð¡ Aksiyon:</strong> HaftalÄ±k 250-350 GRP ile 3+ reach %30-40 hedefleyin.
                    </div>`
                }
            },
            optimum: {
                name: 'Optimum',
                icon: 'âï¸',
                adstock: {
                    main: `<p><strong>ð Grafik Ne GÃ¶steriyor?</strong></p>
                    <ul>
                        <li><strong>Barlar:</strong> HaftalÄ±k Carryover (GRP eq.) - geÃ§miÅ haftalardan taÅÄ±nan etki</li>
                        <li><strong>Ãizgiler:</strong> Toplam Adstock - birikimli reklam etkisi</li>
                    </ul>
                    <p><strong>Optimum Senaryo (Î» = 0.70):</strong> Dengeli decay ile reklam etkisi <span class="highlight-purple">2-3 hafta boyunca %50+ korunur</span>.</p>`,
                    scenario: `<p><strong>âï¸ Grafikte Ne GÃ¶rmelisiniz?</strong></p>
                    <ul>
                        <li>Carryover barlarÄ± orta yÃ¼kseklikte - geÃ§miÅten makul etki taÅÄ±nÄ±yor</li>
                        <li>Adstock Ã§izgileri barlarÄ±n Ã¼zerinde seyreder - birikim etkisi var</li>
                        <li>GRP olmayan haftalarda adstock kademeli dÃ¼Åer ama sÄ±fÄ±rlanmaz</li>
                    </ul>
                    <div class="rationale-recommendation">
                        <strong>ð¡ GrafiÄi NasÄ±l YorumlamalÄ±sÄ±nÄ±z?</strong>
                        <ul>
                            <li><strong>Carryover barlarÄ± yÃ¼ksekse:</strong> GeÃ§miÅ yatÄ±rÄ±mlarÄ±nÄ±z hÃ¢lÃ¢ Ã§alÄ±ÅÄ±yor, burst stratejisi kullanabilirsiniz</li>
                            <li><strong>Adstock Ã§izgisi barlardan yÃ¼ksekse:</strong> GÃ¼Ã§lÃ¼ birikim var, yoÄunlaÅtÄ±rma etkili</li>
                            <li><strong>Alternatifler arasÄ±nda fark varsa:</strong> Daha yÃ¼ksek carryover'lÄ± alternatif uzun vadede verimli</li>
                        </ul>
                    </div>
                    <div class="rationale-recommendation">
                        <strong>ð¯ Aksiyon Ãnerileri:</strong>
                        <ul>
                            <li>2-3 haftalÄ±k burst dÃ¶nemleri planlayabilirsiniz</li>
                            <li>1-2 hafta yayÄ±n arasÄ± (flight) verilebilir</li>
                            <li>Sezonsal yoÄunlaÅtÄ±rma stratejisi uygundur</li>
                            <li>HaftalÄ±k 200-300 GRP ile istikrarlÄ± birikim saÄlayÄ±n</li>
                        </ul>
                    </div>
                    <div class="rationale-tip">
                        <strong>ð Benchmark:</strong> Petrol, telekom, market sektÃ¶rlerinde tipik decay 0.65-0.75 arasÄ±ndadÄ±r.
                    </div>`
                },
                saturation: {
                    main: `<p><strong>Saturation GrafiÄi Ne GÃ¶steriyor?</strong> Harcama arttÄ±kÃ§a elde edilen etkinin nasÄ±l deÄiÅtiÄini gÃ¶sterir.</p>
                    <p><strong>Optimum Senaryo (Î± = 1.5, Î³ = 0.8):</strong> Orta alpha = <span class="highlight-purple">dengeli doygunluk noktasÄ±</span>.</p>`,
                    scenario: `<p><strong>âï¸ Optimum Saturation Ãzellikleri:</strong></p>
                    <ul>
                        <li>Optimal noktaya kadar iyi verim</li>
                        <li>Optimal sonrasÄ± kademeli azalan getiri</li>
                        <li>BÃ¼tÃ§e planlamasÄ±nda esneklik</li>
                    </ul>`
                },
                reach: {
                    main: `<p><strong>GRP-Reach GrafiÄi Ne GÃ¶steriyor?</strong> KÃ¼mÃ¼latif GRP'nin ne kadar kitleye ulaÅtÄ±ÄÄ±nÄ± gÃ¶sterir.</p>`,
                    scenario: `<p><strong>ð Optimum Senaryo iÃ§in Reach Stratejisi:</strong></p>
                    <ul>
                        <li><strong>2+ Reach:</strong> â­ Ãnerilen - maliyet-etkinlik dengesi</li>
                    </ul>
                    <div class="rationale-recommendation">
                        <strong>ð¡ Aksiyon:</strong> 2+ reach %45-55 hedefleyin.
                    </div>`
                }
            },
            maksimum: {
                name: 'Maksimum',
                icon: 'ð',
                adstock: {
                    main: `<p><strong>ð Grafik Ne GÃ¶steriyor?</strong></p>
                    <ul>
                        <li><strong>Barlar:</strong> HaftalÄ±k Carryover (GRP eq.) - geÃ§miÅ haftalardan taÅÄ±nan etki</li>
                        <li><strong>Ãizgiler:</strong> Toplam Adstock - birikimli reklam etkisi</li>
                    </ul>
                    <p><strong>Maksimum Senaryo (Î» = 0.85):</strong> YÃ¼ksek decay ile reklam etkisi <span class="highlight-green">4-5 hafta boyunca %60+ korunur</span>.</p>`,
                    scenario: `<p><strong>ð Grafikte Ne GÃ¶rmelisiniz?</strong></p>
                    <ul>
                        <li>Adstock Ã§izgileri carryover barlarÄ±nÄ±n Ã§ok Ã¼zerinde</li>
                        <li>GRP olmayan haftalarda bile adstock yÃ¼ksek kalÄ±r</li>
                        <li>Peak noktalarÄ± birkaÃ§ hafta gecikmeyle oluÅabilir</li>
                        <li>Carryover barlarÄ± yÃ¼ksek ve uzun sÃ¼re devam eder</li>
                    </ul>
                    <div class="rationale-recommendation">
                        <strong>ð¯ Aksiyon:</strong> Ä°lk 2-3 haftada yoÄun GRP (300+), sonra dÃ¼ÅÃ¼k seviyede sÃ¼rdÃ¼rÃ¼n. Carryover Ã§alÄ±ÅÄ±r!
                    </div>
                    <div class="rationale-tip">
                        <strong>ðª Premium Market:</strong> Lansmanda yoÄun yatÄ±rÄ±m yapÄ±n, carryover etkiyle sÃ¼rdÃ¼rÃ¼n.
                    </div>`
                },
                saturation: {
                    main: `<p><strong>Saturation GrafiÄi Ne GÃ¶steriyor?</strong> Harcama arttÄ±kÃ§a elde edilen etkinin nasÄ±l deÄiÅtiÄini gÃ¶sterir.</p>
                    <p><strong>Maksimum Senaryo (Î± = 2.5, Î³ = 0.6):</strong> YÃ¼ksek alpha = <span class="highlight-green">doygunluÄa ulaÅmak zor</span>.</p>`,
                    scenario: `<p><strong>ð Maksimum Saturation Ãzellikleri:</strong></p>
                    <ul>
                        <li>Ãok yÃ¼ksek GRP'lerde bile doygunluk zor</li>
                        <li>Her ek GRP marjinal katkÄ± saÄlar</li>
                        <li>Uzun vadeli marka inÅasÄ± iÃ§in ideal</li>
                    </ul>`
                },
                reach: {
                    main: `<p><strong>GRP-Reach GrafiÄi Ne GÃ¶steriyor?</strong> KÃ¼mÃ¼latif GRP'nin ne kadar kitleye ulaÅtÄ±ÄÄ±nÄ± gÃ¶sterir.</p>`,
                    scenario: `<p><strong>ð Maksimum Senaryo iÃ§in Reach Stratejisi:</strong></p>
                    <ul>
                        <li><strong>1+ Reach:</strong> â­ Ãnerilen - maksimum kitleye ulaÅÄ±m</li>
                    </ul>
                    <div class="rationale-recommendation">
                        <strong>ð¡ Aksiyon:</strong> 1+ Reach %60+ hedefleyin. Ä°lk 2-3 haftada yoÄun GRP.
                    </div>`
                }
            }
        };

        // Generate dynamic Saturation Rationale based on analysis data
        function generateSaturationRationale(scenario) {
            const alpha = parseFloat(document.getElementById('alphaParam').value);
            const gamma = parseFloat(document.getElementById('gammaParam').value);
            
            // Check if we have analysis data
            if (!analysisData || !analysisData.adstock || analysisData.adstock.length === 0) {
                // No data yet - show basic explanation
                return `
                    ${scenario.saturation.main}
                    <div class="rationale-scenario">
                        <div class="rationale-scenario-title">${scenario.icon} ${scenario.name} Senaryo Etkisi</div>
                        ${scenario.saturation.scenario}
                    </div>
                    <div class="rationale-tip">
                        <strong>ð Analiz Bekleniyor:</strong> Analizi Ã§alÄ±ÅtÄ±rdÄ±ÄÄ±nÄ±zda alternatiflerinizin saturation performansÄ± burada detaylÄ± gÃ¶rÃ¼necek.
                    </div>
                `;
            }

            // Get alternatives data from stored analysis
            const grpAlt1 = document.getElementById('grpAlt1').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const grpAlt2 = document.getElementById('grpAlt2').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const grpAlt3 = document.getElementById('grpAlt3').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const cpp = parseFloat(document.getElementById('cppValue').value) || 25000;
            const decayRate = parseFloat(document.getElementById('decayRate').value);

            // Calculate adstock and saturation for each alternative
            const calcAltMetrics = (grpArr) => {
                if (grpArr.length === 0) return null;
                const spend = grpArr.map(g => g * cpp);
                const adstock = calculateAdstock(spend, decayRate);
                const saturation = adstock.map(a => calculateSaturation(a, alpha, gamma));
                const avgAdstock = adstock.reduce((a, b) => a + b, 0) / adstock.length;
                const avgSaturation = saturation.reduce((a, b) => a + b, 0) / saturation.length;
                const maxSaturation = Math.max(...saturation);
                const minSaturation = Math.min(...saturation);
                const totalGRP = grpArr.reduce((a, b) => a + b, 0);
                const totalSpend = spend.reduce((a, b) => a + b, 0);
                return { avgAdstock, avgSaturation, maxSaturation, minSaturation, adstock, saturation, totalGRP, totalSpend, grp: grpArr };
            };

            const alt1 = calcAltMetrics(grpAlt1);
            const alt2 = calcAltMetrics(grpAlt2);
            const alt3 = calcAltMetrics(grpAlt3);

            // Calculate optimal point
            const allAdstock = [...(alt1?.adstock || []), ...(alt2?.adstock || []), ...(alt3?.adstock || [])];
            const optimalBudget = findOptimalBudget(alpha, gamma, allAdstock);
            const optimalSaturation = calculateSaturation(optimalBudget, alpha, gamma);

            // Calculate optimal GRP
            const optimalGRPPerWeek = cpp > 0 ? optimalBudget / cpp : 0;

            // Helper function for saturation interpretation
            const interpretSaturation = (sat) => {
                if (sat >= 0.90) return { zone: 'AÅÄ±rÄ± Doygun', color: '#ef4444', icon: 'ð´', efficiency: 'Ãok DÃ¼ÅÃ¼k', action: 'BÃ¼tÃ§eyi azalt' };
                if (sat >= 0.80) return { zone: 'Doygun', color: '#f59e0b', icon: 'ð ', efficiency: 'DÃ¼ÅÃ¼k', action: 'Dikkatli ol' };
                if (sat >= 0.65) return { zone: 'Verimli', color: '#10b981', icon: 'ð¢', efficiency: 'YÃ¼ksek', action: 'Devam et' };
                if (sat >= 0.50) return { zone: 'Optimal', color: '#00d4ff', icon: 'ðµ', efficiency: 'Maksimum', action: 'Ä°deal bÃ¶lge' };
                return { zone: 'DÃ¼ÅÃ¼k', color: '#8b5cf6', icon: 'ð£', efficiency: 'Orta', action: 'ArtÄ±rÄ±labilir' };
            };

            // Build detailed saturation explanation
            let saturationExplanation = `
                <div class="rationale-section">
                    <h4 style="color: var(--accent-blue); margin: 0 0 12px 0; font-size: 13px;">ð Saturation Nedir ve NasÄ±l Okunur?</h4>
                    <p style="margin: 0 0 8px 0; font-size: 11px; line-height: 1.5;">
                        <strong>Saturation (%)</strong>, reklam harcamanÄ±zÄ±n potansiyel etkisinin ne kadarÄ±nÄ± kullandÄ±ÄÄ±nÄ±zÄ± gÃ¶sterir. 
                        Hill fonksiyonu ile hesaplanÄ±r ve <strong>azalan getiri</strong> prensibini yansÄ±tÄ±r.
                    </p>
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin: 12px 0;">
                        <p style="margin: 0 0 8px 0; font-size: 10px; color: var(--text-secondary);">Saturation BantlarÄ±:</p>
                        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <span style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 4px 8px; border-radius: 4px; font-size: 9px;">ð£ 0-50% DÃ¼ÅÃ¼k</span>
                            <span style="background: rgba(0, 212, 255, 0.2); color: #00d4ff; padding: 4px 8px; border-radius: 4px; font-size: 9px;">ðµ 50-65% Optimal</span>
                            <span style="background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 8px; border-radius: 4px; font-size: 9px;">ð¢ 65-80% Verimli</span>
                            <span style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 4px 8px; border-radius: 4px; font-size: 9px;">ð  80-90% Doygun</span>
                            <span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 8px; border-radius: 4px; font-size: 9px;">ð´ 90%+ AÅÄ±rÄ±</span>
                        </div>
                    </div>
                </div>
            `;

            // Build comparison table with more details
            let altComparison = `
                <div class="rationale-section" style="margin-top: 16px;">
                    <h4 style="color: var(--accent-blue); margin: 0 0 12px 0; font-size: 13px;">ð Alternatif Analizi</h4>
                    <table class="rationale-table">
                        <thead>
                            <tr>
                                <th>Alt</th>
                                <th>Toplam GRP</th>
                                <th>Ort. Sat.</th>
                                <th>Max Sat.</th>
                                <th>BÃ¶lge</th>
                                <th>Verimlilik</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const evalStatus = (avgSat) => {
                if (avgSat >= 0.85) return { text: 'â ï¸ Doygunluk', class: 'status-warning' };
                if (avgSat >= 0.6) return { text: 'â Verimli', class: 'status-good' };
                return { text: 'ð Potansiyel Var', class: 'status-info' };
            };

            if (alt1) {
                const interp = interpretSaturation(alt1.avgSaturation);
                altComparison += `<tr>
                    <td><span class="alt-badge alt1">1</span></td>
                    <td>${alt1.totalGRP.toFixed(0)}</td>
                    <td><strong>%${(alt1.avgSaturation * 100).toFixed(1)}</strong></td>
                    <td>%${(alt1.maxSaturation * 100).toFixed(1)}</td>
                    <td style="color: ${interp.color}">${interp.icon} ${interp.zone}</td>
                    <td>${interp.efficiency}</td>
                </tr>`;
            }
            if (alt2) {
                const interp = interpretSaturation(alt2.avgSaturation);
                altComparison += `<tr>
                    <td><span class="alt-badge alt2">2</span></td>
                    <td>${alt2.totalGRP.toFixed(0)}</td>
                    <td><strong>%${(alt2.avgSaturation * 100).toFixed(1)}</strong></td>
                    <td>%${(alt2.maxSaturation * 100).toFixed(1)}</td>
                    <td style="color: ${interp.color}">${interp.icon} ${interp.zone}</td>
                    <td>${interp.efficiency}</td>
                </tr>`;
            }
            if (alt3) {
                const interp = interpretSaturation(alt3.avgSaturation);
                altComparison += `<tr>
                    <td><span class="alt-badge alt3">3</span></td>
                    <td>${alt3.totalGRP.toFixed(0)}</td>
                    <td><strong>%${(alt3.avgSaturation * 100).toFixed(1)}</strong></td>
                    <td>%${(alt3.maxSaturation * 100).toFixed(1)}</td>
                    <td style="color: ${interp.color}">${interp.icon} ${interp.zone}</td>
                    <td>${interp.efficiency}</td>
                </tr>`;
            }
            altComparison += '</tbody></table></div>';

            // Find best alternative
            const alts = [
                { name: 'Alt-1', data: alt1, color: '#00d4ff' },
                { name: 'Alt-2', data: alt2, color: '#ff6b35' },
                { name: 'Alt-3', data: alt3, color: '#10b981' }
            ].filter(a => a.data);

            let bestAlt = alts[0];
            
            // Determine best based on efficiency (not too high saturation, not too low)
            alts.forEach(a => {
                // Ideal is around 60-75% saturation
                const distanceFromIdeal = Math.abs(a.data.avgSaturation - 0.68);
                const bestDistance = Math.abs(bestAlt.data.avgSaturation - 0.68);
                if (distanceFromIdeal < bestDistance) {
                    bestAlt = a;
                }
            });

            // Generate detailed interpretation for the primary alternative
            const primaryAlt = alt1;
            const primaryInterp = interpretSaturation(primaryAlt.avgSaturation);
            const satPercent = (primaryAlt.avgSaturation * 100).toFixed(0);
            const remainingPotential = ((1 - primaryAlt.avgSaturation) * 100).toFixed(0);

            let detailedInterpretation = `
                <div class="rationale-section" style="margin-top: 16px;">
                    <h4 style="color: var(--accent-blue); margin: 0 0 12px 0; font-size: 13px;">ð¯ %${satPercent} Saturation Ne Anlama Geliyor?</h4>
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 14px; border-left: 3px solid ${primaryInterp.color};">
                        <p style="margin: 0 0 10px 0; font-size: 12px;">
                            <strong style="color: ${primaryInterp.color}">${primaryInterp.icon} ${primaryInterp.zone} BÃ¶lgesi</strong>
                        </p>
                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; line-height: 1.6;">
                            <li>TV reklam potansiyelinin <strong>%${satPercent}</strong>'ini kullanÄ±yorsunuz</li>
                            <li>Kalan <strong>%${remainingPotential}</strong> potansiyel henÃ¼z aktive edilmemiÅ</li>
                            <li>Her ek 100 GRP iÃ§in marjinal etki: <strong>${primaryAlt.avgSaturation > 0.8 ? 'DÃ¼ÅÃ¼k (azalan getiri)' : primaryAlt.avgSaturation > 0.6 ? 'Orta' : 'YÃ¼ksek'}</strong></li>
                        </ul>
                    </div>
                </div>
            `;

            // Generate action-oriented recommendation
            let recommendation = '';
            const avgSatAll = alts.reduce((sum, a) => sum + a.data.avgSaturation, 0) / alts.length;
            
            if (avgSatAll > 0.85) {
                recommendation = `
                    <div class="rationale-section" style="margin-top: 16px;">
                        <h4 style="color: #ef4444; margin: 0 0 12px 0; font-size: 13px;">â ï¸ Aksiyon: Doygunluk Riski</h4>
                        <div style="background: rgba(239, 68, 68, 0.1); border-radius: 8px; padding: 14px; border: 1px solid rgba(239, 68, 68, 0.3);">
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Problem:</strong> %85+ saturation = Azalan getiri bÃ¶lgesi</p>
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Anlam:</strong> Her ek 1 TL harcama iÃ§in giderek daha az etki alÄ±yorsunuz.</p>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                                <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: 600; color: #ef4444;">ð Ãnerilen Aksiyonlar:</p>
                                <ol style="margin: 0; padding-left: 18px; font-size: 10px; line-height: 1.6;">
                                    <li>HaftalÄ±k GRP'yi <strong>${optimalGRPPerWeek.toFixed(0)} GRP</strong>'ye dÃ¼ÅÃ¼rmeyi deÄerlendirin</li>
                                    <li>Tasarruf edilen bÃ¼tÃ§eyi <strong>dijital kanallara</strong> yÃ¶nlendirin</li>
                                    <li>Veya yayÄ±n sÃ¼resini uzatarak <strong>frekansÄ± dÃ¼ÅÃ¼rÃ¼n</strong></li>
                                    <li>Flight strategy: SÃ¼rekli yerine <strong>pulsing</strong> deneyin</li>
                                </ol>
                            </div>
                        </div>
                    </div>`;
            } else if (avgSatAll > 0.6) {
                recommendation = `
                    <div class="rationale-section" style="margin-top: 16px;">
                        <h4 style="color: #10b981; margin: 0 0 12px 0; font-size: 13px;">â Aksiyon: Verimli BÃ¶lge</h4>
                        <div style="background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 14px; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Durum:</strong> %60-85 saturation = Verimli Ã§alÄ±Åma bÃ¶lgesi</p>
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Anlam:</strong> Harcama-etki dengesi iyi, getiri hala pozitif.</p>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: 600; color: #10b981;">ð Ãnerilen Aksiyonlar:</p>
                                <ol style="margin: 0; padding-left: 18px; font-size: 10px; line-height: 1.6;">
                                    <li><strong>${bestAlt.name}</strong> daÄÄ±lÄ±mÄ±nÄ± referans alÄ±n (Ort: %${(bestAlt.data.avgSaturation * 100).toFixed(1)})</li>
                                    <li>Mevcut GRP seviyesini koruyun</li>
                                    <li>KÃ¼Ã§Ã¼k artÄ±Ålar (%10-15) hala verimli olabilir</li>
                                    <li>Creative rotation ile <strong>wear-out</strong>'u Ã¶nleyin</li>
                                </ol>
                            </div>
                        </div>
                    </div>`;
            } else {
                recommendation = `
                    <div class="rationale-section" style="margin-top: 16px;">
                        <h4 style="color: #00d4ff; margin: 0 0 12px 0; font-size: 13px;">ð Aksiyon: BÃ¼yÃ¼me FÄ±rsatÄ±</h4>
                        <div style="background: rgba(0, 212, 255, 0.1); border-radius: 8px; padding: 14px; border: 1px solid rgba(0, 212, 255, 0.3);">
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Durum:</strong> %60 altÄ± saturation = Kapasite kullanÄ±lmÄ±yor</p>
                            <p style="margin: 0 0 10px 0; font-size: 11px;"><strong>Anlam:</strong> BÃ¼tÃ§e artÄ±ÅÄ± yÃ¼ksek marjinal getiri saÄlayacak.</p>
                            
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0, 212, 255, 0.2);">
                                <p style="margin: 0 0 8px 0; font-size: 11px; font-weight: 600; color: #00d4ff;">ð Ãnerilen Aksiyonlar:</p>
                                <ol style="margin: 0; padding-left: 18px; font-size: 10px; line-height: 1.6;">
                                    <li>HaftalÄ±k GRP'yi <strong>${optimalGRPPerWeek.toFixed(0)} GRP</strong>'ye kadar artÄ±rÄ±n</li>
                                    <li>Optimal bÃ¼tÃ§e: <strong>${(optimalBudget/1000000).toFixed(1)}M TL/hafta</strong></li>
                                    <li>%65-75 saturation hedefleyin (maksimum verimlilik)</li>
                                    <li>ArtÄ±Å %${remainingPotential} potansiyeli aktive edecek</li>
                                </ol>
                            </div>
                        </div>
                    </div>`;
            }

            // Build final HTML
            return `
                ${saturationExplanation}
                ${altComparison}
                ${detailedInterpretation}
                ${recommendation}
                
                <div class="rationale-scenario" style="margin-top: 16px;">
                    <div class="rationale-scenario-title">${scenario.icon} ${scenario.name} Senaryo Etkisi</div>
                    ${scenario.saturation.scenario}
                </div>
            `;
        }

        // Update all rationales based on current scenario and frequency
        function updateAllRationales() {
            try {
                const scenario = scenarioRationales[currentScenario];
                const freq = currentReachFrequency;
                const freqLabel = freq === 'all' ? 'TÃ¼m Frekanslar (1+, 2+, 3+)' : reachParams[freq].label;

                // Adstock Rationale
                document.getElementById('adstockRationale').innerHTML = `
                    ${scenario.adstock.main}
                    <div class="rationale-scenario">
                        <div class="rationale-scenario-title">${scenario.icon} ${scenario.name} Senaryo Etkisi</div>
                        ${scenario.adstock.scenario}
                    </div>
                `;

                // Saturation Rationale - DYNAMIC based on analysis data
                const saturationDynamic = generateSaturationRationale(scenario);
                document.getElementById('saturationRationale').innerHTML = saturationDynamic;

                // Reach Rationale (also depends on frequency)
                const freqExplanation = freq === 'all' ? 
                    `<p><strong>GÃ¶rÃ¼ntÃ¼leme:</strong> TÃ¼m frekans eÄrileri karÅÄ±laÅtÄ±rmalÄ± olarak gÃ¶steriliyor.</p>
                    <ul>
                        <li><span style="color: #00d4ff;">â</span> <strong>Mavi (1+):</strong> En az 1 kez ulaÅÄ±lan kitle</li>
                        <li><span style="color: #ff6b35;">â</span> <strong>Turuncu (2+):</strong> En az 2 kez ulaÅÄ±lan kitle</li>
                        <li><span style="color: #8888a0;">â</span> <strong>Gri (3+):</strong> En az 3 kez ulaÅÄ±lan kitle</li>
                    </ul>` :
                    `<p><strong>SeÃ§ili Frekans: ${freqLabel}</strong></p>`;

                document.getElementById('reachRationale').innerHTML = `
                    ${scenario.reach.main}
                    ${freqExplanation}
                    <div class="rationale-scenario">
                        <div class="rationale-scenario-title">${scenario.icon} ${scenario.name} Senaryo Etkisi</div>
                        ${scenario.reach.scenario}
                    </div>
                `;
            } catch (error) {
                console.error('Update rationales error:', error);
            }
        }

        // Set reach frequency filter
        function setReachFrequency(freq) {
            try {
                currentReachFrequency = freq;
                
                // Update buttons
                document.querySelectorAll('.reach-btn').forEach((btn) => {
                    const btnFreq = btn.textContent.includes('Hepsi') ? 'all' : 
                                   btn.textContent.includes('1+') ? 1 :
                                   btn.textContent.includes('2+') ? 2 : 3;
                    btn.classList.toggle('active', btnFreq === freq);
                });
                
                // Update label
                if (freq === 'all') {
                    document.getElementById('reachFreqLabel').textContent = '1+/2+/3+ Reach';
                } else {
                    document.getElementById('reachFreqLabel').textContent = reachParams[freq].label;
                }
                
                // Redraw reach chart
                updateReachChart();
                
                // Update rationales
                updateAllRationales();
            } catch (error) {
                console.error('Set reach frequency error:', error);
            }
        }

        // Calculate reach based on GRP using logarithmic curve
        function calculateReach(grp, freq) {
            // Handle 'all' case by defaulting to freq 1
            const actualFreq = freq === 'all' ? 1 : freq;
            
            // Get key for lookup (r1, r2, r3)
            const key = 'r' + actualFreq;
            
            // Find surrounding GRP values for interpolation
            const grpKeys = Object.keys(reachLookup).map(Number).sort((a, b) => a - b);
            
            // Clamp GRP to lookup range
            if (grp <= grpKeys[0]) {
                // Linear extrapolation below 50 GRP
                const ratio = grp / grpKeys[0];
                return reachLookup[grpKeys[0]][key] * ratio;
            }
            if (grp >= grpKeys[grpKeys.length - 1]) {
                // Return max value for GRP above 2000
                return reachLookup[grpKeys[grpKeys.length - 1]][key];
            }
            
            // Find lower and upper bounds
            let lowerGRP = grpKeys[0];
            let upperGRP = grpKeys[grpKeys.length - 1];
            
            for (let i = 0; i < grpKeys.length - 1; i++) {
                if (grp >= grpKeys[i] && grp <= grpKeys[i + 1]) {
                    lowerGRP = grpKeys[i];
                    upperGRP = grpKeys[i + 1];
                    break;
                }
            }
            
            // Linear interpolation
            const lowerReach = reachLookup[lowerGRP][key];
            const upperReach = reachLookup[upperGRP][key];
            const ratio = (grp - lowerGRP) / (upperGRP - lowerGRP);
            
            return lowerReach + (upperReach - lowerReach) * ratio;
        }

        // Find optimal GRP (where marginal reach gain drops below threshold)
        function findOptimalGRP(freq) {
            // Handle 'all' case by defaulting to freq 1
            const actualFreq = freq === 'all' ? 1 : freq;
            const key = 'r' + actualFreq;
            
            // Find where marginal gain drops below 0.02% per GRP
            const grpKeys = Object.keys(reachLookup).map(Number).sort((a, b) => a - b);
            
            for (let i = 1; i < grpKeys.length; i++) {
                const prevGRP = grpKeys[i - 1];
                const currGRP = grpKeys[i];
                const prevReach = reachLookup[prevGRP][key];
                const currReach = reachLookup[currGRP][key];
                const marginalGain = (currReach - prevReach) / (currGRP - prevGRP);
                
                if (marginalGain < 0.02) {
                    return prevGRP;
                }
            }
            
            return 500; // Default fallback
        }

        // Set input mode
        // Initialize charts
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#8888a0',
                            font: { family: 'Sora', size: 11 }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#8888a0', font: { size: 10 } }
                    },
                    y: {
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#8888a0', font: { size: 10 } }
                    }
                }
            };

            // Adstock Chart - Stacked bar (Actual + Carried-Over) + Line (Total Adstock)
            adstockChart = new Chart(document.getElementById('adstockChart'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        annotation: {
                            annotations: {}
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.raw;
                                    if (label === 'Total Adstock') {
                                        return `${label}: ${value.toFixed(0)} GRP eq.`;
                                    }
                                    return `${label}: ${value.toFixed(0)} GRP`;
                                }
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                color: '#8888a0',
                                font: { size: 10 },
                                usePointStyle: true,
                                padding: 15
                            }
                        }
                    },
                    scales: {
                        x: chartOptions.scales.x,
                        y: {
                            ...chartOptions.scales.y,
                            stacked: true,
                            title: { display: false },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Saturation Chart with annotation
            saturationChart = new Chart(document.getElementById('saturationChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Saturation Curve',
                            data: [],
                            borderColor: '#ff6b35',
                            backgroundColor: 'rgba(255, 107, 53, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2
                        },
                        {
                            label: 'Veri NoktalarÄ±',
                            data: [],
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            pointRadius: 8,
                            pointStyle: 'circle',
                            showLine: false
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        annotation: {
                            annotations: {}
                        }
                    },
                    scales: {
                        x: {
                            ...chartOptions.scales.x,
                            type: 'linear',
                            title: { display: true, text: 'Harcama (Milyon TL)', color: '#8888a0' }
                        },
                        y: {
                            ...chartOptions.scales.y,
                            title: { display: true, text: 'Saturation (%)', color: '#8888a0' },
                            max: 1
                        }
                    }
                }
            });

            // Reach Chart
            reachChart = new Chart(document.getElementById('reachChart'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: '1+ Reach',
                            data: [],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        annotation: {
                            annotations: {}
                        },
                        tooltip: {
                            mode: 'nearest',
                            intersect: true,
                            filter: function(tooltipItem, index) {
                                // Sadece "Kampanya Verileri" dataset'ini gÃ¶ster ve sadece ilk item
                                if (!tooltipItem.dataset.label) return false;
                                if (!tooltipItem.dataset.label.includes('Kampanya') && 
                                    !tooltipItem.dataset.label.includes('Alt-1')) return false;
                                return index === 0; // Sadece ilk item'Ä± gÃ¶ster
                            },
                            callbacks: {
                                label: function(context) {
                                    return `Reach: %${context.parsed.y.toFixed(1)}`;
                                },
                                title: function(context) {
                                    return `GRP: ${Math.round(context[0].parsed.x)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ...chartOptions.scales.x,
                            type: 'linear',
                            title: { 
                                display: true, 
                                text: 'GRP', 
                                color: '#8888a0',
                                padding: { top: 0, bottom: 0 }
                            },
                            min: 0,
                            max: 400
                        },
                        y: {
                            ...chartOptions.scales.y,
                            title: { display: true, text: 'EriÅim Seviyesi (%)', color: '#8888a0' },
                            min: 0,
                            max: 85
                        }
                    }
                }
            });
        }

        // Update Reach Chart
        function updateReachChart() {
            try {
                const freq = currentReachFrequency;
                const maxGRPRange = 2000;
                
                // Colors for each frequency
                const freqColors = {
                    1: { border: '#00d4ff', bg: 'rgba(0, 212, 255, 0.1)', point: '#00d4ff' },
                    2: { border: '#ff6b35', bg: 'rgba(255, 107, 53, 0.1)', point: '#ff6b35' },
                    3: { border: '#8888a0', bg: 'rgba(136, 136, 160, 0.1)', point: '#8888a0' }
                };
                
                let datasets = [];
                
                if (freq === 'all') {
                    // Show all three curves
                    [1, 2, 3].forEach(f => {
                        const curveData = [];
                        for (let grp = 0; grp <= maxGRPRange; grp += 50) {
                            const reach = calculateReach(grp, f);
                            curveData.push({ x: grp, y: reach });
                        }
                        datasets.push({
                            label: reachParams[f].label,
                            data: curveData,
                            borderColor: freqColors[f].border,
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 0,
                            borderWidth: 2
                        });
                    });
                    
                    // Add data points for ALL frequencies if analysis data exists
                    if (analysisData.grp && analysisData.grp.length > 0) {
                        [1, 2, 3].forEach(f => {
                            const dataPoints = [];
                            let cumulativeGRP = 0;
                            
                            analysisData.grp.forEach((g, i) => {
                                cumulativeGRP += g;
                                const reach = calculateReach(cumulativeGRP, f);
                                dataPoints.push({ x: cumulativeGRP, y: reach });
                            });
                            
                            datasets.push({
                                label: `Alt-1 (${f}+)`,
                                data: dataPoints,
                                borderColor: freqColors[f].point,
                                backgroundColor: freqColors[f].point,
                                pointRadius: 5,
                                pointStyle: 'circle',
                                showLine: false
                            });
                        });
                    }
                    
                    reachChart.options.plugins.annotation.annotations = {};
                    
                    const reach1at250 = calculateReach(250, 1);
                    document.getElementById('reachMaxGRP').textContent = maxGRPRange;
                    document.getElementById('reachMaxPercent').textContent = `%${reach1at250.toFixed(1)} (1+)`;
                    document.getElementById('reachOptimalGRP').textContent = '-';
                    
                } else {
                    // Single frequency mode
                    const params = reachParams[freq];
                    const curveData = [];
                    
                    for (let grp = 0; grp <= maxGRPRange; grp += 50) {
                        const reach = calculateReach(grp, freq);
                        curveData.push({ x: grp, y: reach });
                    }
                    
                    datasets.push({
                        label: params.label,
                        data: curveData,
                        borderColor: freqColors[freq].border,
                        backgroundColor: freqColors[freq].bg,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHitRadius: 0,
                        borderWidth: 2
                    });
                    
                    const optimalGRP = findOptimalGRP(freq);
                    const optimalReach = calculateReach(optimalGRP, freq);
                    
                    reachChart.options.plugins.annotation.annotations = {
                        optimalLine: {
                            type: 'line',
                            xMin: optimalGRP,
                            xMax: optimalGRP,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            label: {
                                display: true,
                                content: [`Optimal: ${Math.round(optimalGRP)} GRP`, `Reach: %${optimalReach.toFixed(1)}`],
                                position: 'start',
                                backgroundColor: '#ef4444',
                                color: 'white',
                                font: { size: 10 }
                            }
                        }
                    };
                    
                    // Add data points for THIS frequency
                    if (analysisData.grp && analysisData.grp.length > 0) {
                        const dataPoints = [];
                        let cumulativeGRP = 0;
                        
                        analysisData.grp.forEach((g, i) => {
                            cumulativeGRP += g;
                            const reach = calculateReach(cumulativeGRP, freq);
                            dataPoints.push({ x: cumulativeGRP, y: reach });
                        });
                        
                        datasets.push({
                            label: 'Kampanya Verileri',
                            data: dataPoints,
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            pointRadius: 6,
                            pointStyle: 'circle',
                            showLine: false
                        });
                    }
                    
                    const maxGRPRef = 250;
                    const reachAt250 = calculateReach(maxGRPRef, freq);
                    document.getElementById('reachMaxGRP').textContent = maxGRPRef;
                    document.getElementById('reachMaxPercent').textContent = `%${reachAt250.toFixed(1)}`;
                    document.getElementById('reachOptimalGRP').textContent = Math.round(optimalGRP);
                }
                
                // Set tooltip to show only nearest point, not all datasets
                reachChart.options.interaction = {
                    mode: 'nearest',
                    intersect: true
                };
                
                reachChart.data.datasets = datasets;
                reachChart.options.scales.x.max = maxGRPRange;
                reachChart.update();
            } catch (error) {
                console.error('Reach chart update error:', error);
            }
        }

        // Calculate Adstock
        function calculateAdstock(spend, decay) {
            const adstock = [];
            for (let i = 0; i < spend.length; i++) {
                if (i === 0) {
                    adstock.push(spend[i]);
                } else {
                    adstock.push(spend[i] + decay * adstock[i - 1]);
                }
            }
            return adstock;
        }

        // Calculate Saturation (Hill function)
        function calculateSaturation(value, alpha, gamma) {
            const scaledValue = value / 1000000; // Scale to millions
            const alphaGamma = Math.pow(alpha, gamma);
            const valueGamma = Math.pow(scaledValue, gamma);
            return valueGamma / (alphaGamma + valueGamma);
        }

        // Find optimal budget point (where marginal return drops significantly)
        // Find optimal budget - now takes actual adstock values into account
        function findOptimalBudget(alpha, gamma, adstockValues) {
            // If we have actual adstock values, find the point of diminishing returns
            // based on the marginal efficiency curve
            if (adstockValues && adstockValues.length > 0) {
                const maxAdstock = Math.max(...adstockValues);
                const avgAdstock = adstockValues.reduce((a, b) => a + b, 0) / adstockValues.length;
                
                // Optimal is where marginal saturation starts declining significantly
                // For Hill function: inflection point is around alpha
                // Scale alpha to the actual data range
                const scaleFactor = avgAdstock / (alpha * 1000000);
                
                // Optimal is typically at 50-70% of saturation
                // Find the adstock value that gives ~50% saturation
                const targetSaturation = 0.5;
                // Inverse Hill function: x = alpha * (S / (1-S))^(1/gamma)
                const optimalAdstock = alpha * 1000000 * Math.pow(targetSaturation / (1 - targetSaturation), 1 / gamma);
                
                return optimalAdstock;
            }
            
            // Fallback: theoretical optimal based on alpha
            return alpha * 0.6 * 1000000;
        }

        // Run Analysis
        function runAnalysis() {
            const decayRate = parseFloat(document.getElementById('decayRate').value);
            const alpha = parseFloat(document.getElementById('alphaParam').value);
            const gamma = parseFloat(document.getElementById('gammaParam').value);
            const baseline = parseFloat(document.getElementById('baseline').value);
            const maxLift = parseFloat(document.getElementById('maxLift').value) / 100;
            const cpp = parseFloat(document.getElementById('cppValue').value) || 25000;

            // Get effective levels
            const effectiveLow = parseFloat(document.getElementById('effectiveLow').value) || 195;
            const effectiveHigh = parseFloat(document.getElementById('effectiveHigh').value) || 300;

            // Get 3 alternatives
            const grpAlt1 = document.getElementById('grpAlt1').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const grpAlt2 = document.getElementById('grpAlt2').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
            const grpAlt3 = document.getElementById('grpAlt3').value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));

            if (grpAlt1.length === 0) {
                alert('LÃ¼tfen en az Alt-1 iÃ§in GRP verisi girin!');
                return;
            }

            // Store effective levels globally for charts
            window.effectiveLevels = { low: effectiveLow, high: effectiveHigh };

            // Calculate spend from GRP
            const spendAlt1 = grpAlt1.map(g => g * cpp);
            const spendAlt2 = grpAlt2.map(g => g * cpp);
            const spendAlt3 = grpAlt3.map(g => g * cpp);

            // Update summary
            const totalGRP1 = grpAlt1.reduce((a, b) => a + b, 0);
            const totalGRP2 = grpAlt2.length > 0 ? grpAlt2.reduce((a, b) => a + b, 0) : 0;
            const totalGRP3 = grpAlt3.length > 0 ? grpAlt3.reduce((a, b) => a + b, 0) : 0;
            
            document.getElementById('summaryAlt1').textContent = `${totalGRP1} GRP`;
            document.getElementById('summaryAlt2').textContent = grpAlt2.length > 0 ? `${totalGRP2} GRP` : '- GRP';
            document.getElementById('summaryAlt3').textContent = grpAlt3.length > 0 ? `${totalGRP3} GRP` : '- GRP';

            // Calculate for each alternative
            const calcAlternative = (spend, grp) => {
                if (spend.length === 0) return null;
                const adstock = calculateAdstock(spend, decayRate);
                const saturation = adstock.map(a => calculateSaturation(a, alpha, gamma));
                const tvEffect = saturation.map(s => baseline * maxLift * s);
                const response = saturation.map((s, i) => baseline + tvEffect[i]);
                const weeklyEfficiency = spend.map((s, i) => s > 0 ? (tvEffect[i] / s) : 0);
                const totalSpend = spend.reduce((a, b) => a + b, 0);
                const totalTVEffect = tvEffect.reduce((a, b) => a + b, 0);
                const totalResponse = response.reduce((a, b) => a + b, 0);
                return { spend, grp, adstock, saturation, tvEffect, response, weeklyEfficiency, totalSpend, totalTVEffect, totalResponse };
            };

            const alt1 = calcAlternative(spendAlt1, grpAlt1);
            const alt2 = calcAlternative(spendAlt2, grpAlt2);
            const alt3 = calcAlternative(spendAlt3, grpAlt3);

            // Store primary data for export (Alt-1)
            analysisData = { 
                spend: alt1.spend, 
                grp: grpAlt1, 
                adstock: alt1.adstock, 
                saturation: alt1.saturation, 
                tvEffect: alt1.tvEffect, 
                response: alt1.response, 
                weeklyROI: alt1.spend.map((s, i) => s > 0 ? ((alt1.tvEffect[i] / s) * 100) : 0),
                weeklyEfficiency: alt1.weeklyEfficiency 
            };

            // Calculate summary metrics (using Alt-1 as primary)
            // Combine all adstock values for optimal calculation
            const allAdstockValues = [...alt1.adstock];
            if (alt2) allAdstockValues.push(...alt2.adstock);
            if (alt3) allAdstockValues.push(...alt3.adstock);
            
            const optimalBudget = findOptimalBudget(alpha, gamma, allAdstockValues);
            const peakEffect = Math.max(...alt1.saturation) * 100;
            const tvEfficiencyIndex = alt1.totalSpend > 0 ? (alt1.totalTVEffect / alt1.totalSpend) * 100 : 0;

            // Update metrics cards
            document.getElementById('totalSpend').textContent = formatNumber(alt1.totalSpend) + ' TL';
            document.getElementById('avgAdstock').textContent = formatNumber(alt1.adstock.reduce((a, b) => a + b, 0) / alt1.adstock.length);
            document.getElementById('peakEffect').textContent = peakEffect.toFixed(1) + '%';
            document.getElementById('totalResponse').textContent = formatNumber(alt1.totalResponse) + ' TL';
            document.getElementById('tvEfficiency').textContent = tvEfficiencyIndex.toFixed(1);
            document.getElementById('overallROI').textContent = formatNumber(alt1.totalTVEffect) + ' TL';
            document.getElementById('optimalBudget').textContent = formatNumber(optimalBudget) + ' TL/hafta';

            // Determine max weeks for labels
            const maxWeeks = Math.max(grpAlt1.length, grpAlt2.length || 0, grpAlt3.length || 0);
            const labels = Array.from({length: maxWeeks}, (_, i) => `H${i + 1}`);

            // Store data for adstock/carryover chart updates
            window.adstockData = {
                labels,
                alt1: { grp: grpAlt1, adstock: alt1.adstock, spend: spendAlt1 },
                alt2: alt2 ? { grp: grpAlt2, adstock: alt2.adstock, spend: spendAlt2 } : null,
                alt3: alt3 ? { grp: grpAlt3, adstock: alt3.adstock, spend: spendAlt3 } : null
            };

            // Store data for saturation chart (GRP-based)
            // Calculate adstock in GRP terms
            const calcAdstockGRP = (grpArray, decayRate) => {
                const adstockGRP = [];
                let currentAdstock = 0;
                for (let i = 0; i < grpArray.length; i++) {
                    currentAdstock = grpArray[i] + (currentAdstock * decayRate);
                    adstockGRP.push(currentAdstock);
                }
                return adstockGRP;
            };

            const adstockGRP1 = calcAdstockGRP(grpAlt1, decayRate);
            const adstockGRP2 = alt2 ? calcAdstockGRP(grpAlt2, decayRate) : null;
            const adstockGRP3 = alt3 ? calcAdstockGRP(grpAlt3, decayRate) : null;

            // Calculate optimal in GRP terms
            const allGRPAdstock = [...adstockGRP1, ...(adstockGRP2 || []), ...(adstockGRP3 || [])];
            const maxGRPAdstock = Math.max(...allGRPAdstock);
            
            // Find optimal GRP (where marginal efficiency starts declining significantly)
            // Alpha is in millions TL, we need to convert to GRP scale
            // Use the ratio of max adstock values to scale
            const maxAdstockTL = Math.max(...adstockGRP1.map((_, i) => alt1.adstock[i]));
            const maxAdstockGRP = Math.max(...adstockGRP1);
            
            // Scale alpha from TL to GRP
            // alpha is in units where 1.0 = 1M TL, so alpha * 1M = TL value
            const alphaTL = alpha * 1000000; // Convert to TL
            const tlToGrpRatio = maxAdstockGRP / maxAdstockTL;
            const alphaGRP = alphaTL * tlToGrpRatio;
            
            // Optimal is around alpha point (half-saturation)
            const optimalGRP = alphaGRP;

            window.saturationData = {
                alt1: { 
                    grp: grpAlt1, 
                    adstockGRP: adstockGRP1, 
                    adstockTL: alt1.adstock, 
                    saturation: alt1.saturation,
                    spend: spendAlt1
                },
                alt2: alt2 ? { 
                    grp: grpAlt2, 
                    adstockGRP: adstockGRP2, 
                    adstockTL: alt2.adstock, 
                    saturation: alt2.saturation,
                    spend: spendAlt2
                } : null,
                alt3: alt3 ? { 
                    grp: grpAlt3, 
                    adstockGRP: adstockGRP3, 
                    adstockTL: alt3.adstock, 
                    saturation: alt3.saturation,
                    spend: spendAlt3
                } : null,
                alpha: alpha,
                alphaGRP: alphaGRP,
                gamma: gamma,
                optimalBudget: optimalBudget,
                optimalGRP: optimalGRP,
                tlToGrpRatio: tlToGrpRatio
            };

            // Update Adstock Chart with current selection
            updateAdstockChart();

            // Update Saturation Chart
            updateSaturationChart();

            // Update Reach Chart
            updateReachChart();
        }

        // Saturation X-axis mode: 'grp' or 'spend'
        let saturationXAxisMode = 'grp';

        function setSaturationXAxis(mode) {
            saturationXAxisMode = mode;
            document.getElementById('satToggleGRP').classList.toggle('active', mode === 'grp');
            document.getElementById('satToggleSpend').classList.toggle('active', mode === 'spend');
            updateSaturationChart();
        }

        function updateSaturationChart() {
            if (!window.saturationData) return;
            
            const data = window.saturationData;
            const alpha = data.alpha;
            const alphaGRP = data.alphaGRP;
            const gamma = data.gamma;
            const isGRP = saturationXAxisMode === 'grp';

            // Get adstock values based on mode
            const getAdstock = (altData) => isGRP ? altData.adstockGRP : altData.adstockTL;
            const getOptimal = () => isGRP ? data.optimalGRP : data.optimalBudget;
            // For GRP mode use alphaGRP, for TL mode use alpha*1000000 (convert from millions)
            const getAlpha = () => isGRP ? alphaGRP : (alpha * 1000000);

            // Build curve data
            const allAdstock = [
                ...getAdstock(data.alt1), 
                ...(data.alt2 ? getAdstock(data.alt2) : []), 
                ...(data.alt3 ? getAdstock(data.alt3) : [])
            ];
            const maxVal = Math.max(...allAdstock) * 1.5;
            const currentAlpha = getAlpha();

            const curveData = [];
            for (let i = 0; i <= 50; i++) {
                const x = (maxVal / 50) * i;
                // Use Hill function: x^gamma / (alpha^gamma + x^gamma)
                const sat = Math.pow(x, gamma) / (Math.pow(currentAlpha, gamma) + Math.pow(x, gamma));
                curveData.push({ x: isGRP ? x : x / 1000000, y: sat });
            }

            // Build datasets
            const divisor = isGRP ? 1 : 1000000;
            
            saturationChart.data.datasets = [
                {
                    label: 'Saturation EÄrisi',
                    data: curveData,
                    borderColor: '#8888a0',
                    backgroundColor: 'rgba(136, 136, 160, 0.05)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 1
                },
                {
                    label: 'Alt-1',
                    data: getAdstock(data.alt1).map((a, i) => ({ x: a / divisor, y: data.alt1.saturation[i] })),
                    borderColor: '#00d4ff',
                    backgroundColor: '#00d4ff',
                    pointRadius: 6,
                    pointStyle: 'circle',
                    showLine: false
                }
            ];

            if (data.alt2) {
                saturationChart.data.datasets.push({
                    label: 'Alt-2',
                    data: getAdstock(data.alt2).map((a, i) => ({ x: a / divisor, y: data.alt2.saturation[i] })),
                    borderColor: '#ff6b35',
                    backgroundColor: '#ff6b35',
                    pointRadius: 6,
                    pointStyle: 'triangle',
                    showLine: false
                });
            }

            if (data.alt3) {
                saturationChart.data.datasets.push({
                    label: 'Alt-3',
                    data: getAdstock(data.alt3).map((a, i) => ({ x: a / divisor, y: data.alt3.saturation[i] })),
                    borderColor: '#10b981',
                    backgroundColor: '#10b981',
                    pointRadius: 6,
                    pointStyle: 'rect',
                    showLine: false
                });
            }

            // Optimal line annotation
            const optimalVal = getOptimal();
            const optimalX = isGRP ? optimalVal : optimalVal / 1000000;
            const optimalLabel = isGRP ? `Optimal: ${optimalVal.toFixed(0)} GRP` : `Optimal: ${(optimalVal / 1000000).toFixed(1)}M TL`;

            saturationChart.options.plugins.annotation.annotations = {
                optimalLine: {
                    type: 'line',
                    xMin: optimalX,
                    xMax: optimalX,
                    borderColor: '#ef4444',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    label: {
                        display: true,
                        content: optimalLabel,
                        position: 'start',
                        backgroundColor: '#ef4444',
                        color: 'white',
                        font: { size: 10 }
                    }
                }
            };

            // Update X-axis title
            saturationChart.options.scales.x.title = {
                display: true,
                text: isGRP ? 'Adstock (GRP)' : 'Adstock (Milyon TL)',
                color: '#8888a0'
            };

            saturationChart.update();
        }

        // Update Adstock Chart based on selected alternative
        function updateAdstockChart() {
            if (!window.adstockData) return;
            
            const data = window.adstockData;
            const alt1 = data.alt1;
            const alt2 = data.alt2;
            const alt3 = data.alt3;
            
            if (!alt1) return;
            
            const decay = parseFloat(document.getElementById('decayRate').value);
            
            // Calculate how many extra weeks to show carryover tail
            // Continue until carryover drops below 5% of peak
            const calcExtendedData = (grp, adstock, spend) => {
                const maxGRP = Math.max(...grp);
                const maxAdstock = Math.max(...adstock);
                const scaleFactor = maxAdstock > 0 ? maxGRP / maxAdstock : 1;
                
                // Scale original adstock to GRP
                const adstockGRP = adstock.map(a => a * scaleFactor);
                
                // Calculate original carryover
                const carryoverGRP = adstock.map((a, i) => {
                    const carryover = Math.max(0, a - spend[i]);
                    return carryover * scaleFactor;
                });
                
                // Extend with carryover tail (no new GRP, just decay)
                const extendedGRP = [...grp];
                const extendedAdstock = [...adstockGRP];
                const extendedCarryover = [...carryoverGRP];
                
                // Get last adstock value
                let lastAdstock = adstockGRP[adstockGRP.length - 1];
                const peakAdstock = Math.max(...adstockGRP);
                const threshold = peakAdstock * 0.05; // Stop when below 5% of peak
                
                // Add tail weeks
                let week = grp.length;
                while (lastAdstock * decay > threshold && week < grp.length + 8) {
                    const tailCarryover = lastAdstock * decay;
                    extendedGRP.push(0); // No new GRP
                    extendedAdstock.push(tailCarryover);
                    extendedCarryover.push(tailCarryover);
                    lastAdstock = tailCarryover;
                    week++;
                }
                
                return {
                    grp: extendedGRP,
                    adstock: extendedAdstock,
                    carryover: extendedCarryover,
                    originalLength: grp.length
                };
            };

            // Colors for alternatives
            const colors = {
                alt1: { bar: 'rgba(0, 212, 255, 0.6)', border: '#00d4ff', line: '#00d4ff' },
                alt2: { bar: 'rgba(255, 107, 53, 0.6)', border: '#ff6b35', line: '#ff6b35' },
                alt3: { bar: 'rgba(16, 185, 129, 0.6)', border: '#10b981', line: '#10b981' }
            };

            const ext1 = calcExtendedData(alt1.grp, alt1.adstock, alt1.spend);
            
            // Generate extended labels
            const extendedLabels = [];
            for (let i = 0; i < ext1.grp.length; i++) {
                extendedLabels.push('H' + (i + 1));
            }

            adstockChart.data.labels = extendedLabels;
            adstockChart.data.datasets = [
                // Alt-1 GRP Bar (Actual Investment)
                {
                    label: 'Alt-1 GRP',
                    data: ext1.grp,
                    type: 'bar',
                    backgroundColor: ext1.grp.map((g, i) => g > 0 ? colors.alt1.bar : 'transparent'),
                    borderColor: ext1.grp.map((g, i) => g > 0 ? colors.alt1.border : 'transparent'),
                    borderWidth: 1,
                    order: 3,
                    pointStyle: 'rect'
                },
                // Alt-1 Adstock Line
                {
                    label: 'Alt-1 Adstock',
                    data: ext1.adstock,
                    type: 'line',
                    borderColor: colors.alt1.line,
                    backgroundColor: 'transparent',
                    borderWidth: 2.5,
                    pointRadius: 3,
                    pointBackgroundColor: colors.alt1.line,
                    tension: 0.3,
                    fill: false,
                    order: 1,
                    pointStyle: 'circle'
                }
            ];
            
            // Add Alt-2 if exists
            if (alt2) {
                const ext2 = calcExtendedData(alt2.grp, alt2.adstock, alt2.spend);
                
                // Pad to match length
                while (ext2.grp.length < ext1.grp.length) {
                    const lastAdstock = ext2.adstock[ext2.adstock.length - 1];
                    ext2.grp.push(0);
                    ext2.adstock.push(lastAdstock * decay);
                }
                
                adstockChart.data.datasets.push(
                    {
                        label: 'Alt-2 GRP',
                        data: ext2.grp,
                        type: 'bar',
                        backgroundColor: ext2.grp.map((g, i) => g > 0 ? colors.alt2.bar : 'transparent'),
                        borderColor: ext2.grp.map((g, i) => g > 0 ? colors.alt2.border : 'transparent'),
                        borderWidth: 1,
                        order: 3,
                        pointStyle: 'rect'
                    },
                    {
                        label: 'Alt-2 Adstock',
                        data: ext2.adstock,
                        type: 'line',
                        borderColor: colors.alt2.line,
                        backgroundColor: 'transparent',
                        borderWidth: 2.5,
                        pointRadius: 3,
                        pointBackgroundColor: colors.alt2.line,
                        tension: 0.3,
                        fill: false,
                        order: 1,
                        pointStyle: 'circle'
                    }
                );
            }
            
            // Add Alt-3 if exists
            if (alt3) {
                const ext3 = calcExtendedData(alt3.grp, alt3.adstock, alt3.spend);
                
                // Pad to match length
                while (ext3.grp.length < ext1.grp.length) {
                    const lastAdstock = ext3.adstock[ext3.adstock.length - 1];
                    ext3.grp.push(0);
                    ext3.adstock.push(lastAdstock * decay);
                }
                
                adstockChart.data.datasets.push(
                    {
                        label: 'Alt-3 GRP',
                        data: ext3.grp,
                        type: 'bar',
                        backgroundColor: ext3.grp.map((g, i) => g > 0 ? colors.alt3.bar : 'transparent'),
                        borderColor: ext3.grp.map((g, i) => g > 0 ? colors.alt3.border : 'transparent'),
                        borderWidth: 1,
                        order: 3,
                        pointStyle: 'rect'
                    },
                    {
                        label: 'Alt-3 Adstock',
                        data: ext3.adstock,
                        type: 'line',
                        borderColor: colors.alt3.line,
                        backgroundColor: 'transparent',
                        borderWidth: 2.5,
                        pointRadius: 3,
                        pointBackgroundColor: colors.alt3.line,
                        tension: 0.3,
                        fill: false,
                        order: 1,
                        pointStyle: 'circle'
                    }
                );
            }
            
            // Update scales
            adstockChart.options.scales.x.stacked = false;
            adstockChart.options.scales.x.title = { 
                display: true, 
                text: 'Hafta', 
                color: '#8888a0' 
            };
            adstockChart.options.scales.y.stacked = false;
            adstockChart.options.scales.y.title = { 
                display: true, 
                text: 'GRP / Adstock', 
                color: '#8888a0' 
            };
            adstockChart.options.scales.y.beginAtZero = true;
            
            // Add vertical line annotation to show where GRP ends
            // Get effective levels from global settings
            const effectiveLow = window.effectiveLevels?.low || 195;
            const effectiveHigh = window.effectiveLevels?.high || 300;
            
            adstockChart.options.plugins.annotation = {
                annotations: {
                    grpEndLine: {
                        type: 'line',
                        xMin: ext1.originalLength - 0.5,
                        xMax: ext1.originalLength - 0.5,
                        borderColor: 'rgba(150, 150, 150, 0.5)',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: 'GRP Sonu',
                            position: 'start',
                            backgroundColor: 'rgba(150, 150, 150, 0.8)',
                            color: '#fff',
                            font: { size: 9 }
                        }
                    },
                    effectiveLowLine: {
                        type: 'line',
                        yMin: effectiveLow,
                        yMax: effectiveLow,
                        borderColor: 'rgba(245, 158, 11, 0.7)',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        label: {
                            display: true,
                            content: `Etkin Alt: ${effectiveLow} GRP`,
                            position: 'start',
                            backgroundColor: 'rgba(245, 158, 11, 0.9)',
                            color: '#fff',
                            font: { size: 9 },
                            padding: 4
                        }
                    },
                    effectiveHighLine: {
                        type: 'line',
                        yMin: effectiveHigh,
                        yMax: effectiveHigh,
                        borderColor: 'rgba(16, 185, 129, 0.7)',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        label: {
                            display: true,
                            content: `Etkin Ãst: ${effectiveHigh} GRP`,
                            position: 'start',
                            backgroundColor: 'rgba(16, 185, 129, 0.9)',
                            color: '#fff',
                            font: { size: 9 },
                            padding: 4
                        }
                    }
                }
            };
            
            adstockChart.update();
            
            // Generate dynamic rationale with extended data
            generateAdstockRationale(alt1, alt2, alt3, ext1, decay);
        }
        
        // Generate dynamic Adstock rationale with specific numbers
        function generateAdstockRationale(alt1, alt2, alt3, ext1, decay) {
            const scenario = scenarioRationales[currentScenario];
            
            // Calculate week-by-week analysis for Alt-1 (including tail)
            const weekAnalysis = [];
            for (let i = 0; i < ext1.adstock.length; i++) {
                const grp = ext1.grp[i];
                const adstock = ext1.adstock[i];
                const prevAdstock = i > 0 ? ext1.adstock[i-1] : 0;
                const carryoverFromPrev = prevAdstock * decay;
                
                weekAnalysis.push({
                    week: i + 1,
                    grp: grp,
                    adstock: adstock,
                    carryoverFromPrev: carryoverFromPrev,
                    isOriginal: i < ext1.originalLength,
                    isTail: i >= ext1.originalLength
                });
            }
            
            // Find key insights
            const totalGRP = alt1.grp.reduce((a, b) => a + b, 0);
            const avgAdstock = ext1.adstock.reduce((a, b) => a + b, 0) / ext1.adstock.length;
            const peakAdstock = Math.max(...ext1.adstock);
            const peakWeek = ext1.adstock.indexOf(peakAdstock) + 1;
            
            // Calculate total carryover benefit (adstock beyond original weeks)
            const tailWeeks = ext1.adstock.length - ext1.originalLength;
            const tailAdstockSum = ext1.adstock.slice(ext1.originalLength).reduce((a, b) => a + b, 0);
            
            // Build week-by-week explanation
            let weekByWeekHTML = '<div class="week-analysis">';
            weekByWeekHTML += '<p><strong>ð Hafta Hafta Alt-1 Analizi:</strong></p>';
            weekByWeekHTML += '<div class="week-breakdown">';
            
            // Show all weeks including tail
            for (let i = 0; i < weekAnalysis.length; i++) {
                const w = weekAnalysis[i];
                const nextW = weekAnalysis[i + 1];
                
                const tailClass = w.isTail ? ' tail-week' : '';
                weekByWeekHTML += `<div class="week-item${tailClass}">`;
                weekByWeekHTML += `<span class="week-label">H${w.week}:</span>`;
                
                if (i === 0) {
                    // First week
                    weekByWeekHTML += `<span class="week-detail">${w.grp} GRP yatÄ±rÄ±m â Adstock: <strong>${w.adstock.toFixed(0)}</strong></span>`;
                    if (nextW) {
                        const expectedCarryover = (w.adstock * decay).toFixed(0);
                        weekByWeekHTML += `<span class="week-carryover">â H${w.week + 1}'e ${expectedCarryover} taÅÄ±nacak</span>`;
                    }
                } else if (w.isTail) {
                    // Tail weeks (no GRP, just carryover)
                    weekByWeekHTML += `<span class="week-detail tail-text">0 GRP + ${w.carryoverFromPrev.toFixed(0)} carryover â Adstock: <strong>${w.adstock.toFixed(0)}</strong></span>`;
                    weekByWeekHTML += `<span class="week-badge">Carryover Tail</span>`;
                } else {
                    // Middle weeks
                    const prevCarryover = w.carryoverFromPrev.toFixed(0);
                    weekByWeekHTML += `<span class="week-detail">${w.grp} GRP + ${prevCarryover} carryover â Adstock: <strong>${w.adstock.toFixed(0)}</strong></span>`;
                }
                weekByWeekHTML += `</div>`;
            }
            
            weekByWeekHTML += '</div></div>';
            
            // Summary insights
            let summaryHTML = `
                <div class="adstock-summary">
                    <p><strong>ð Alt-1 Ãzet:</strong></p>
                    <ul>
                        <li>Toplam GRP YatÄ±rÄ±mÄ±: <strong>${totalGRP}</strong> (${ext1.originalLength} hafta)</li>
                        <li>Peak Adstock: H${peakWeek}'de <strong>${peakAdstock.toFixed(0)}</strong></li>
                        <li>Carryover Tail: <strong>${tailWeeks} hafta</strong> daha etki devam ediyor</li>
                        <li>Tail Toplam DeÄer: <strong>${tailAdstockSum.toFixed(0)}</strong> GRP eq. ekstra etki</li>
                    </ul>
                </div>
            `;
            
            // Decay explanation with visual
            const decaySteps = [100];
            for (let i = 0; i < 5; i++) {
                decaySteps.push(decaySteps[decaySteps.length - 1] * decay);
            }
            
            let decayHTML = `
                <div class="decay-explanation">
                    <p><strong>â±ï¸ Decay = ${decay.toFixed(2)} Ne Anlama Geliyor?</strong></p>
                    <p>Her hafta, Ã¶nceki haftanÄ±n adstock'unun <strong>%${(decay * 100).toFixed(0)}</strong>'i bir sonraki haftaya taÅÄ±nÄ±r.</p>
                    <div class="decay-visual">
                        <span>100</span> â <span>${decaySteps[1].toFixed(0)}</span> â <span>${decaySteps[2].toFixed(0)}</span> â <span>${decaySteps[3].toFixed(0)}</span> â <span>${decaySteps[4].toFixed(0)}</span> â <span>${decaySteps[5].toFixed(0)}</span>
                    </div>
                    <p class="decay-note">GRP bittiÄinde bile etki ${tailWeeks} hafta daha sÃ¼rer!</p>
                </div>
            `;
            
            // Combine all into rationale
            const rationaleEl = document.getElementById('adstockRationale');
            rationaleEl.innerHTML = `
                ${scenario.adstock.main}
                ${weekByWeekHTML}
                ${summaryHTML}
                ${decayHTML}
                <div class="rationale-scenario">
                    <div class="rationale-scenario-title">${scenario.icon} ${scenario.name} Senaryo Etkisi</div>
                    ${scenario.adstock.scenario}
                </div>
            `;
        }

        // Format number
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toFixed(0);
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Toggle card collapse
        function toggleCard(header) {
            header.closest('.card').classList.toggle('collapsed');
        }

        // Apply scenario presets - Min/Opt/Max
        function applyScenario(scenario) {
            currentScenario = scenario; // Update global scenario
            
            // Update buttons - support both old and new class names
            document.querySelectorAll('.scenario-btn, .scenario-btn-v').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                const btn = event.target.closest('.scenario-btn-v') || event.target.closest('.scenario-btn') || event.target;
                btn.classList.add('active');
            }

            // Scenario parameters
            const scenarios = {
                minimum: { decay: 0.45, alpha: 1.0, gamma: 1.3 },      // KÄ±sa etki, erken doygunluk, hÄ±zlÄ± baÅlangÄ±Ã§
                optimum: { decay: 0.70, alpha: 1.5, gamma: 0.8 },      // Orta etki, normal doygunluk, dengeli
                maksimum: { decay: 0.85, alpha: 2.5, gamma: 0.6 }      // Uzun etki, geÃ§ doygunluk, yavaÅ baÅlangÄ±Ã§
            };

            const s = scenarios[scenario];
            document.getElementById('decayRate').value = s.decay;
            document.getElementById('decayValue').textContent = s.decay.toFixed(2);
            document.getElementById('alphaParam').value = s.alpha;
            document.getElementById('alphaValue').textContent = s.alpha.toFixed(2);
            document.getElementById('gammaParam').value = s.gamma;
            document.getElementById('gammaValue').textContent = s.gamma.toFixed(2);

            // Update all tab rationales
            updateAllRationales();

            runAnalysis();
        }

        // Export to CSV
        function exportCSV() {
            if (!analysisData.spend || analysisData.spend.length === 0) {
                alert('Ãnce analizi Ã§alÄ±ÅtÄ±rÄ±n!');
                return;
            }

            const headers = ['Hafta', 'Harcama (TL)', 'GRP', 'Adstock', 'Saturation (%)', 'TV Etkisi (TL)', 'Toplam SatÄ±Å (TL)', 'ROI (%)', 'TV Efficiency'];
            const rows = analysisData.spend.map((s, i) => [
                `Hafta ${i + 1}`,
                s.toFixed(0),
                analysisData.grp[i].toFixed(0),
                analysisData.adstock[i].toFixed(0),
                (analysisData.saturation[i] * 100).toFixed(2),
                analysisData.tvEffect[i].toFixed(0),
                analysisData.response[i].toFixed(0),
                analysisData.weeklyROI[i].toFixed(2),
                (analysisData.weeklyEfficiency[i] * 100).toFixed(2)
            ]);

            let csv = '\uFEFF'; // BOM for Excel UTF-8
            csv += headers.join(';') + '\n';
            csv += rows.map(r => r.join(';')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'tv_analyzer_export.csv';
            link.click();
        }

        // Update parameter displays
        document.getElementById('decayRate').addEventListener('input', (e) => {
            document.getElementById('decayValue').textContent = parseFloat(e.target.value).toFixed(2);
        });

        document.getElementById('alphaParam').addEventListener('input', (e) => {
            document.getElementById('alphaValue').textContent = parseFloat(e.target.value).toFixed(2);
        });

        document.getElementById('gammaParam').addEventListener('input', (e) => {
            document.getElementById('gammaValue').textContent = parseFloat(e.target.value).toFixed(2);
        });

        // =====================================================
        // MODEL FIT - Pyodide Python Integration
        // =====================================================
        
        // Open/Close Modal
        function openModelFitModal() {
            document.getElementById('modelFitModal').style.display = 'flex';
        }
        
        function closeModelFitModal() {
            document.getElementById('modelFitModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.getElementById('modelFitModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'modelFitModal') {
                closeModelFitModal();
            }
        });
        
        // Load Pyodide
        async function initPyodide() {
            if (pyodideReady) return pyodide;
            
            updateProgress(10, 'Pyodide yÃ¼kleniyor...');
            
            // Load Pyodide script dynamically
            if (!window.loadPyodide) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js';
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
            }
            
            updateProgress(30, 'Python runtime baÅlatÄ±lÄ±yor...');
            pyodide = await window.loadPyodide();
            
            updateProgress(50, 'NumPy & SciPy yÃ¼kleniyor...');
            await pyodide.loadPackage(['numpy', 'scipy']);
            
            updateProgress(70, 'Model kodu yÃ¼kleniyor...');
            
            // Load the fitting code
            await pyodide.runPythonAsync(`
import numpy as np
from scipy.optimize import minimize, differential_evolution

def adstock_transform(x, decay):
    """Apply adstock transformation with given decay rate"""
    adstocked = np.zeros_like(x, dtype=float)
    adstocked[0] = x[0]
    for i in range(1, len(x)):
        adstocked[i] = x[i] + decay * adstocked[i-1]
    return adstocked

def saturation_hill(x, alpha, gamma):
    """Hill saturation function"""
    x = np.maximum(x, 1e-10)  # Avoid division by zero
    return np.power(x, gamma) / (np.power(alpha, gamma) + np.power(x, gamma))

def predict_sales(tv_spend, decay, alpha, gamma, baseline, tv_coef):
    """Predict sales given parameters"""
    adstocked = adstock_transform(tv_spend, decay)
    saturated = saturation_hill(adstocked, alpha, gamma)
    return baseline + tv_coef * saturated

def objective(params, tv_spend, sales):
    """Objective function to minimize (MSE)"""
    decay, alpha, gamma, baseline, tv_coef = params
    
    # Bounds check
    if decay < 0 or decay > 0.99:
        return 1e10
    if alpha < 0.1 or alpha > 10:
        return 1e10
    if gamma < 0.1 or gamma > 3:
        return 1e10
    if baseline < 0:
        return 1e10
    if tv_coef < 0:
        return 1e10
    
    predicted = predict_sales(tv_spend, decay, alpha, gamma, baseline, tv_coef)
    mse = np.mean((sales - predicted) ** 2)
    return mse

def fit_model(tv_spend, sales):
    """Fit the model to data using differential evolution"""
    tv_spend = np.array(tv_spend, dtype=float)
    sales = np.array(sales, dtype=float)
    
    # Normalize for better optimization
    tv_scale = np.max(tv_spend) if np.max(tv_spend) > 0 else 1
    sales_scale = np.max(sales) if np.max(sales) > 0 else 1
    
    tv_norm = tv_spend / tv_scale
    sales_norm = sales / sales_scale
    
    # Bounds: decay, alpha, gamma, baseline, tv_coef
    bounds = [
        (0.1, 0.95),   # decay
        (0.1, 5.0),    # alpha (normalized)
        (0.3, 2.0),    # gamma
        (0.0, 1.0),    # baseline (normalized)
        (0.0, 2.0)     # tv_coef (normalized)
    ]
    
    # Use differential evolution for global optimization
    result = differential_evolution(
        objective, 
        bounds, 
        args=(tv_norm, sales_norm),
        maxiter=200,
        seed=42,
        polish=True
    )
    
    decay, alpha_norm, gamma, baseline_norm, tv_coef_norm = result.x
    
    # Denormalize alpha
    alpha = alpha_norm * tv_scale
    
    # Calculate R-squared
    predicted_norm = predict_sales(tv_norm, decay, alpha_norm, gamma, baseline_norm, tv_coef_norm)
    ss_res = np.sum((sales_norm - predicted_norm) ** 2)
    ss_tot = np.sum((sales_norm - np.mean(sales_norm)) ** 2)
    r_squared = 1 - (ss_res / ss_tot) if ss_tot > 0 else 0
    
    return {
        'decay': float(decay),
        'alpha': float(alpha),
        'gamma': float(gamma),
        'r_squared': float(r_squared),
        'success': result.success
    }
            `);
            
            updateProgress(100, 'HazÄ±r!');
            pyodideReady = true;
            return pyodide;
        }
        
        // Update progress bar
        function updateProgress(percent, text) {
            document.getElementById('fitProgress').style.display = 'block';
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        // Run model fitting
        async function runModelFit() {
            const runBtn = document.querySelector('.fit-run-btn');
            runBtn.disabled = true;
            runBtn.innerHTML = '<span>â³</span> ÃalÄ±ÅÄ±yor...';
            
            try {
                // Get input data
                const salesText = document.getElementById('fitSalesData').value;
                const tvText = document.getElementById('fitTVData').value;
                
                const sales = salesText.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                const tv = tvText.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
                
                if (sales.length < 4 || tv.length < 4) {
                    alert('En az 4 haftalÄ±k veri gerekli!');
                    throw new Error('Yetersiz veri');
                }
                
                if (sales.length !== tv.length) {
                    alert('SatÄ±Å ve TV verisi aynÄ± uzunlukta olmalÄ±!');
                    throw new Error('Veri uyuÅmazlÄ±ÄÄ±');
                }
                
                // Load Pyodide if not ready
                await initPyodide();
                
                updateProgress(80, 'Model optimize ediliyor...');
                
                // Run the model
                const result = await pyodide.runPythonAsync(`
import json
sales_data = ${JSON.stringify(sales)}
tv_data = ${JSON.stringify(tv)}
result = fit_model(tv_data, sales_data)
json.dumps(result)
                `);
                
                fittedParams = JSON.parse(result);
                
                updateProgress(100, 'TamamlandÄ±!');
                
                // Display results
                document.getElementById('fitResults').style.display = 'block';
                document.getElementById('fitDecay').textContent = fittedParams.decay.toFixed(2);
                document.getElementById('fitAlpha').textContent = fittedParams.alpha.toFixed(2);
                document.getElementById('fitGamma').textContent = fittedParams.gamma.toFixed(2);
                document.getElementById('fitR2').textContent = (fittedParams.r_squared * 100).toFixed(1) + '%';
                
                // Generate RÂ² quality and rationale
                generateFitRationale(fittedParams);
                
                // Show apply button
                document.getElementById('fitApplyBtn').style.display = 'flex';
                
                // Auto apply if checked
                if (document.getElementById('fitAutoApply').checked) {
                    applyFitParams();
                }
                
                // Update status
                document.getElementById('modelFitStatus').innerHTML = '<span class="status-text" style="color: var(--accent-green);">â RÂ² = ' + (fittedParams.r_squared * 100).toFixed(1) + '%</span>';
                document.getElementById('modelFitStatus').classList.add('success');
                
            } catch (error) {
                console.error('Model fit error:', error);
                updateProgress(0, 'Hata: ' + error.message);
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = '<span>ð</span> Modeli ÃalÄ±ÅtÄ±r';
            }
        }
        
        // Generate RÂ² quality and rationale
        function generateFitRationale(params) {
            const r2 = params.r_squared;
            const r2Pct = r2 * 100;
            
            // Determine quality level
            let quality, qualityClass, qualityText;
            if (r2 >= 0.85) {
                quality = 'excellent';
                qualityClass = 'excellent';
                qualityText = 'MÃ¼kemmel';
            } else if (r2 >= 0.70) {
                quality = 'good';
                qualityClass = 'good';
                qualityText = 'Ä°yi';
            } else if (r2 >= 0.50) {
                quality = 'acceptable';
                qualityClass = 'acceptable';
                qualityText = 'Kabul Edilebilir';
            } else {
                quality = 'poor';
                qualityClass = 'poor';
                qualityText = 'DÃ¼ÅÃ¼k';
            }
            
            // Update quality indicator
            const qualityEl = document.getElementById('fitR2Quality');
            qualityEl.textContent = qualityText;
            qualityEl.className = 'param-quality ' + qualityClass;
            
            // Determine decay interpretation
            let decayInterp;
            if (params.decay < 0.5) {
                decayInterp = 'KÄ±sa sÃ¼reli etki - FMCG/promosyon kategorisi';
            } else if (params.decay < 0.75) {
                decayInterp = 'Orta sÃ¼reli etki - Perakende/telekom kategorisi';
            } else {
                decayInterp = 'Uzun sÃ¼reli etki - Otomotiv/lÃ¼ks kategorisi';
            }
            
            // Generate rationale HTML
            const rationaleHTML = `
                <h5>ð RÂ² (R-Kare) Nedir?</h5>
                <p>RÂ² deÄeri, modelin verilerinizi ne kadar iyi aÃ§Ä±kladÄ±ÄÄ±nÄ± gÃ¶sterir. <strong>${r2Pct.toFixed(1)}%</strong> demek, TV harcamalarÄ±ndaki deÄiÅim satÄ±Ålardaki deÄiÅimin <strong>%${r2Pct.toFixed(0)}'ini</strong> aÃ§Ä±klÄ±yor demektir.</p>
                
                <div class="r2-scale">
                    <span>0%</span>
                    <div class="r2-bar">
                        <div class="r2-marker" style="left: ${Math.min(r2Pct, 100)}%;"></div>
                    </div>
                    <span>100%</span>
                </div>
                <div class="r2-labels">
                    <span>DÃ¼ÅÃ¼k (&lt;50%)</span>
                    <span>Kabul (50-70%)</span>
                    <span>Ä°yi (70-85%)</span>
                    <span>MÃ¼kemmel (&gt;85%)</span>
                </div>
                
                <div class="fit-interpretation">
                    <div class="interp-title ${qualityClass}">
                        ${quality === 'excellent' ? 'â MÃ¼kemmel Model Uyumu' : 
                          quality === 'good' ? 'ð Ä°yi Model Uyumu' : 
                          quality === 'acceptable' ? 'â ï¸ Kabul Edilebilir Uyum' : 
                          'â ï¸ DÃ¼ÅÃ¼k Model Uyumu'}
                    </div>
                    <ul>
                        ${quality === 'excellent' ? `
                            <li>Model verilerinizi Ã§ok iyi aÃ§Ä±klÄ±yor</li>
                            <li>Bulunan parametreler gÃ¼venilir</li>
                            <li>TV'nin satÄ±Åa etkisi net gÃ¶rÃ¼lÃ¼yor</li>
                        ` : quality === 'good' ? `
                            <li>Model verilerinizi iyi aÃ§Ä±klÄ±yor</li>
                            <li>Parametreler bÃ¼yÃ¼k Ã¶lÃ§Ã¼de gÃ¼venilir</li>
                            <li>DiÄer faktÃ¶rler de satÄ±ÅÄ± etkiliyor olabilir</li>
                        ` : quality === 'acceptable' ? `
                            <li>Model kÄ±smen aÃ§Ä±klayÄ±cÄ±</li>
                            <li>Daha fazla veri ile iyileÅtirilebilir</li>
                            <li>Promosyon, sezonsellik gibi faktÃ¶rler eklenebilir</li>
                        ` : `
                            <li>Model yetersiz aÃ§Ä±klama saÄlÄ±yor</li>
                            <li>Veri kalitesini kontrol edin</li>
                            <li>TV dÄ±ÅÄ± faktÃ¶rler baskÄ±n olabilir</li>
                        `}
                        <li><strong>Decay:</strong> ${decayInterp}</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('fitRationale').innerHTML = rationaleHTML;
        }
        
        // Apply fitted parameters to the analyzer
        function applyFitParams() {
            if (!fittedParams) return;
            
            // Update sliders
            document.getElementById('decayRate').value = fittedParams.decay;
            document.getElementById('decayValue').textContent = fittedParams.decay.toFixed(2);
            
            // Clamp alpha to slider range
            const alphaVal = Math.min(Math.max(fittedParams.alpha, 0.5), 5);
            document.getElementById('alphaParam').value = alphaVal;
            document.getElementById('alphaValue').textContent = alphaVal.toFixed(2);
            
            // Clamp gamma to slider range
            const gammaVal = Math.min(Math.max(fittedParams.gamma, 0.3), 2);
            document.getElementById('gammaParam').value = gammaVal;
            document.getElementById('gammaValue').textContent = gammaVal.toFixed(2);
            
            // Clear scenario selection (now using custom params)
            document.querySelectorAll('.scenario-btn-v').forEach(btn => btn.classList.remove('active'));
            
            // Run analysis with new params
            runAnalysis();
            
            // Close modal
            closeModelFitModal();
            
            // Show notification
            showNotification('Parametreler uygulandÄ±! Decay: ' + fittedParams.decay.toFixed(2) + ', Alpha: ' + alphaVal.toFixed(2) + ', Gamma: ' + gammaVal.toFixed(2));
        }
        
        // Simple notification
        function showNotification(message) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--accent-green), #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 500;
                z-index: 2000;
                animation: slideIn 0.3s ease;
            `;
            notif.textContent = message;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            updateAllRationales();
            runAnalysis();
        });
    </script>
</body>
</html>
